<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.ico">
  <title>é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿ - ä»»å‹™è©³æƒ…</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pageBg: "#020617",
            cardBg: "#020617"
          }
        }
      }
    }
  </script>

  <!-- è‡ªè¨‚æ¨£å¼ï¼ˆç™½å¡ã€å­—è‰²ç­‰ç­‰ï¼‰ -->
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-pageBg text-slate-200">
  <div class="min-h-screen flex flex-col">
    <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <!-- å·¦å´ Logo + æ¨™é¡Œ -->
    <div class="flex items-center gap-3">
      <div
        class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-amber-400 text-sm font-extrabold text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center">
        é™¶
      </div>
      <div>
        <div class="text-sm font-semibold text-slate-100">
          é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿
        </div>
        <div class="text-xs text-slate-400">
          æ ¡åœ’äº’åŠ©ä»»å‹™å¹³å°
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šæ¡Œæ©Ÿå°è¦½ + ä½¿ç”¨è€…è³‡è¨Š + ç™»å‡º -->
    <div class="flex items-center gap-3 text-sm">
      <!-- é›»è…¦ç‰ˆå°è¦½åˆ— -->
      <nav class="hidden sm:flex items-center gap-2">
        <!-- ä»»å‹™å»£å ´ -->
        <a
          href="tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navTasks"
        >
          ä»»å‹™å»£å ´
        </a>

        <!-- æˆ‘çš„ä»»å‹™ -->
        <a
          href="my_tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navMyTasks"
        >
          æˆ‘çš„ä»»å‹™
        </a>

        <!-- æ­·å²ç´€éŒ„ -->
        <a
          href="task_history.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navHistory"
        >
          æ­·å²ç´€éŒ„
        </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  å…¬å‘Š
</a>
        <!-- å€‹äººè³‡æ–™ -->
        <a
          href="profile.html"
          class="rounded-full bg-indigo-500 px-3 py-1 text-xs font-medium text-white shadow hover:bg-indigo-400"
          id="navProfile"
        >
          å€‹äººè³‡æ–™
        </a>
      </nav>

      <!-- ä½¿ç”¨è€…æš±ç¨± / å­¸æ ¡ï¼ˆå¦‚æœæœ‰ï¼‰ -->
      <span
        id="userInfo"
        class="hidden sm:inline text-xs text-slate-300 max-w-[160px] truncate text-right"
      ></span>

      <!-- ç™»å‡ºæŒ‰éˆ• -->
      <button
        id="logoutBtn"
        class="px-3 py-1 rounded-full text-xs border border-slate-600 text-slate-200 hover:bg-slate-800/80"
      >
        ç™»å‡º
      </button>
    </div>
  </div>
</header>


    <!-- ä¸»å…§å®¹ -->
    <main class="flex-1 px-4 py-6">
      <div class="max-w-3xl mx-auto space-y-4">
        <!-- breadcrumb / å›ä¸Šä¸€é  -->
        <div class="flex items-center justify-between">
          <button
            id="backBtn"
            class="inline-flex items-center gap-1 text-xs text-slate-300 hover:text-white">
            <span>â†</span>
            <span>å›ä»»å‹™å»£å ´</span>
          </button>
          <span id="detailMessage" class="text-xs text-slate-400"></span>
        </div>

        <!-- ä»»å‹™å¡ç‰‡ -->
        <section class="bg-white rounded-2xl shadow-xl border border-slate-200 px-5 py-5">
          <!-- ç‹€æ…‹ + æ¨™é¡Œ -->
          <div class="flex flex-col gap-2">
            <div class="flex items-center gap-2">
              <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
              <div id="statusLabel"
                   class="text-xs font-semibold tracking-wide text-slate-500">
                è®€å–ä¸­â€¦
              </div>
            </div>
            <h1 id="taskTitleText"
                class="text-lg sm:text-xl font-semibold text-slate-900">
              ä»»å‹™è¼‰å…¥ä¸­â€¦
            </h1>
          </div>

          <!-- åŸºæœ¬è³‡è¨Š -->
          <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-slate-600">
            <span id="categoryChip"
                  class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 border border-slate-200">
              é¡åˆ¥ï¼šâ€”
            </span>
            <span id="rewardText" class="inline-flex items-center gap-1">
              ğŸ’° <span>é…¬å‹ï¼šâ€”</span>
            </span>
            <span id="deadlineText" class="inline-flex items-center gap-1">
              â° <span>æˆªæ­¢æ—¥æœŸï¼šâ€”</span>
            </span>
            <span id="createdAtText" class="inline-flex items-center gap-1">
              ğŸ•’ <span>ç™¼å¸ƒæ™‚é–“ï¼šâ€”</span>
            </span>
          </div>

          <!-- ç™¼å–® / æ¥å–®è³‡è¨Š -->
          <div class="mt-4 grid gap-2 text-sm text-slate-700 sm:grid-cols-2">
  <div>
  <span class="text-slate-500">ç™¼å–®è€…ï¼š</span>

  <span
    id="creatorNickname"
    class="font-medium text-slate-900 cursor-pointer hover:text-indigo-600 hover:underline"
  >
    â€”
  </span>

  <span id="creatorKnightLevel"
  class="ml-1 inline-flex items-center rounded-full border border-amber-300 bg-amber-50 px-2 py-[2px] text-[11px] font-semibold text-amber-700 align-middle"
  ></span>
</div>
  <div>
    <span class="text-slate-500">æ¥å–®è€…ï¼š</span>
    <span
    id="takerNickname"
    class="font-medium text-slate-900 cursor-pointer hover:text-indigo-600 hover:underline"
  >
    â€”
  </span>
    <span
      id="takerKnightLevel"
      class="ml-1 inline-flex items-center rounded-full border border-amber-300 bg-amber-50 px-2 py-[2px] text-[11px] font-semibold text-amber-700 align-middle"
    ></span>
  </div>
</div>

          <!-- ä»»å‹™èªªæ˜ -->
          <div class="mt-5 border-t border-slate-200 pt-4">
            <h2 class="text-xs font-semibold text-slate-500 mb-1">ä»»å‹™èªªæ˜</h2>
            <p id="descriptionText" class="text-sm leading-relaxed text-slate-800">
              ï¼ˆç„¡èªªæ˜ï¼‰
            </p>
          </div>

          <!-- æŒ‰éˆ•å€ -->
          <div class="mt-5 pt-4 border-t border-slate-200 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <p class="text-xs text-slate-400">
              â€» åƒ…åŒä¸€ä½ç™¼å–®è€…èˆ‡æ¥å–®è€…å¯é€²å…¥èŠå¤©å®¤ã€‚
            </p>
            <div class="flex flex-wrap gap-2 justify-end">
              <button
                id="acceptBtn"
                class="hidden px-3 py-1.5 rounded-full bg-indigo-500 text-xs font-medium text-white shadow shadow-indigo-500/40 hover:bg-indigo-400">
                æ¥ä¸‹é€™å–®
              </button>
              <button
                id="chatBtn"
                class="hidden px-3 py-1.5 rounded-full bg-emerald-500 text-xs font-medium text-white shadow shadow-emerald-500/40 hover:bg-emerald-400">
                æ‰“é–‹èŠå¤©å®¤
              </button>
              <button
                id="completeBtn"
                class="hidden px-3 py-1.5 rounded-full bg-slate-800 text-xs font-medium text-white shadow hover:bg-slate-700">
                æ¨™è¨˜ç‚ºå·²å®Œæˆ
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>
      <!-- ä»»å‹™è©•åƒ¹å€å¡Šï¼ˆåªçµ¦å®Œæˆä»»å‹™ã€ä¸”ä½ æ˜¯ä»»å‹™é›™æ–¹æ™‚é¡¯ç¤ºï¼‰ -->
      <section id="reviewSection" class="mt-6 hidden">
        <h2 class="text-base font-semibold text-slate-100 mb-2">ä»»å‹™è©•åƒ¹</h2>

        <!-- æˆ‘çµ¦å°æ–¹çš„è©•åƒ¹ï¼ˆå·²é€å‡ºæ™‚é¡¯ç¤ºï¼‰ -->
       <div
  id="myReviewBox"
  class="mb-3 hidden text-sm text-slate-800 bg-slate-200 rounded-xl px-4 py-3">
</div>


        <!-- è©•åƒ¹è¡¨å–®ï¼ˆå°šæœªè©•åƒ¹æ™‚é¡¯ç¤ºï¼‰ -->
        <form
          id="reviewForm"
          class="bg-slate-800/40 border border-slate-700 rounded-xl px-4 py-3 mb-3 space-y-2">
          <div class="text-sm text-slate-100 font-medium">
            çµ¦å°æ–¹ä¸€å€‹è©•åƒ¹
          </div>

          <div class="flex items-center gap-2 text-yellow-400 text-lg">
            <label><input type="radio" name="rating" value="1" class="mr-1">â˜…</label>
            <label><input type="radio" name="rating" value="2" class="mr-1">â˜…â˜…</label>
            <label><input type="radio" name="rating" value="3" class="mr-1">â˜…â˜…â˜…</label>
            <label><input type="radio" name="rating" value="4" class="mr-1">â˜…â˜…â˜…â˜…</label>
            <label><input type="radio" name="rating" value="5" class="mr-1">â˜…â˜…â˜…â˜…â˜…</label>
          </div>

          <textarea
  id="reviewComment"
  rows="3"
  class="w-full rounded-lg bg-slate-100 border border-slate-300 text-sm text-slate-800 px-3 py-2"
  placeholder="å¯ä»¥ç°¡å–®å¯«ä¸€ä¸‹åˆä½œå¿ƒå¾—ï¼ˆé¸å¡«ï¼‰"></textarea>

          <div class="flex items-center justify-between text-xs text-slate-400">
            <span id="reviewMsg" class="text-red-400"></span>
            <button
              type="submit"
              class="px-3 py-1 rounded-full bg-indigo-500 text-xs text-white hover:bg-indigo-400">
              é€å‡ºè©•åƒ¹
            </button>
          </div>
        </form>

        <!-- å°æ–¹çµ¦æˆ‘çš„è©•åƒ¹ -->
        <div
  id="otherReviewBox"
  class="hidden text-sm text-slate-800 bg-slate-200 rounded-xl px-4 py-3">
</div>

      </section>

  <!-- æ‰‹æ©Ÿåº•éƒ¨å°è¦½åˆ—ï¼ˆå°è¢å¹•é¡¯ç¤ºï¼‰ -->
  <nav
    class="fixed bottom-0 inset-x-0 z-30 border-t border-slate-800 bg-slate-950/95 backdrop-blur sm:hidden">
    <!-- æ‰‹æ©Ÿåº•éƒ¨å°è¦½åˆ—ï¼ˆå°è¢å¹•ï¼‰ -->
<div
  class="fixed bottom-0 inset-x-0 sm:hidden bg-slate-950/95 backdrop-blur border-t border-slate-800 flex justify-around py-2 text-[11px] text-slate-300 z-20"
>
  <a
    href="tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavTasks"
  >
    <span>ä»»å‹™</span>
    <!-- å°åœ“é»ç•¶å‰é æŒ‡ç¤ºç”¨ï¼Œé è¨­éš±è—ï¼Œç”±æ¯é è‡ªè¡Œæ±ºå®šè¦ä¸è¦é¡¯ç¤º -->
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="my_tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavMyTasks"
  >
    <span>æˆ‘çš„</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="task_history.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavHistory"
  >
    <span>æ­·å²</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  å…¬å‘Š
</a>
  <a
    href="profile.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavProfile"
  >
    <span>è³‡æ–™</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
</div>

  </nav>
  </div>

  <!-- Firebase / ä»»å‹™è©³æƒ…ç¨‹å¼ç¢¼ -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    updateDoc,
    collection,
    addDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyBGbRsMSuSoW4rx11n6T1Kz8KyLTRqzHvU",
    authDomain: "taoki-knight-board.firebaseapp.com",
    projectId: "taoki-knight-board",
    storageBucket: "taoki-knight-board.firebasestorage.app",
    messagingSenderId: "319225747276",
    appId: "1:319225747276:web:5556b601dca17e760121e9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM å…ƒç´ 
  const userInfoEl = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");
  const backBtn = document.getElementById("backBtn");
  const detailMessageEl = document.getElementById("detailMessage");

  const statusDotEl = document.getElementById("statusDot");
  const statusLabelEl = document.getElementById("statusLabel");
  const titleEl = document.getElementById("taskTitleText");
  const categoryChipEl = document.getElementById("categoryChip");
  const rewardEl = document.getElementById("rewardText");
  const deadlineEl = document.getElementById("deadlineText");
  const createdAtEl = document.getElementById("createdAtText");
  const creatorNicknameEl = document.getElementById("creatorNickname");
  const takerNicknameEl = document.getElementById("takerNickname");
  const descriptionEl = document.getElementById("descriptionText");

  const creatorKnightLevelEl = document.getElementById("creatorKnightLevel");
const takerKnightLevelEl = document.getElementById("takerKnightLevel");

  const acceptBtn = document.getElementById("acceptBtn");
  const chatBtn = document.getElementById("chatBtn");
  const completeBtn = document.getElementById("completeBtn");

  // è©•åƒ¹ç›¸é—œå…ƒç´ 
  const reviewSection = document.getElementById("reviewSection");
  const myReviewBox = document.getElementById("myReviewBox");
  const otherReviewBox = document.getElementById("otherReviewBox");
  const reviewForm = document.getElementById("reviewForm");
  const reviewComment = document.getElementById("reviewComment");
  const reviewMsg = document.getElementById("reviewMsg");
  const reviewStarInputs = document.querySelectorAll("input[name='rating']");

  // è©•åƒ¹æš«å­˜
  let myReview = null;
  let otherReview = null;

  // å–å¾— taskId
  const params = new URLSearchParams(window.location.search);
  const taskId = params.get("taskId");

  if (!taskId) {
    alert("ç¼ºå°‘ taskIdï¼Œç„¡æ³•é¡¯ç¤ºä»»å‹™è©³æƒ…ã€‚");
    window.location.href = "tasks.html";
  }

  let currentUser = null;
  let currentUserProfile = null;
  let currentTask = null;
// é»æš±ç¨± â†’ åˆ°å°æ–¹çš„å…¬é–‹é¨å£«è³‡æ–™é 
function goToUserProfile(uid) {
  if (!uid) return;
  window.location.href = `user_profile.html?uid=${encodeURIComponent(uid)}`;
}

if (creatorNicknameEl) {
  creatorNicknameEl.addEventListener("click", () => {
    if (currentTask && currentTask.creatorId) {
      goToUserProfile(currentTask.creatorId);
    }
  });
}

if (takerNicknameEl) {
  takerNicknameEl.addEventListener("click", () => {
    if (currentTask && currentTask.takerId) {
      goToUserProfile(currentTask.takerId);
    }
  });
}

  // ç™»å‡º
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // å›ä»»å‹™å»£å ´
  backBtn.addEventListener("click", () => {
    window.location.href = "tasks.html";
  });

  // é¡åˆ¥æ–‡å­—
  function getCategoryLabel(value) {
    switch (value) {
      case "homework":
        return "ä½œæ¥­ / è³‡æº";
      case "borrow":
        return "å€Ÿç‰©ï¼ˆç­†ã€é¡æ–™ã€é“å…·â€¦ï¼‰";
      case "errand":
        return "è·‘è…¿ / ä»£è²·";
      case "other":
        return "å…¶ä»–";
      default:
        return value || "æœªåˆ†é¡";
    }
  }

  function formatDate(d) {
    if (!d) return "æœªè¨­å®š";
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hour = String(d.getHours()).padStart(2, "0");
    const minute = String(d.getMinutes()).padStart(2, "0");
    return `${year}/${month}/${day} ${hour}:${minute}`;
  }

  function toJsDate(maybeTs) {
    if (!maybeTs) return null;
    if (typeof maybeTs.toDate === "function") return maybeTs.toDate();
    if (maybeTs instanceof Date) return maybeTs;
    return null;
  }
  // === é¨å£«ç­‰ç´šç›¸é—œ ===
  // é€™è£¡å¯ä»¥ç”¨è·Ÿ profile é é¢ä¸€æ¨£çš„è¦å‰‡ï¼Œä½ å¦‚æœæœ‰è‡ªå·±çš„ç‰ˆæœ¬ä¹Ÿå¯ä»¥æ”¹
  // === é¨å£«ç­‰ç´šè¦å‰‡ï¼ˆèˆ‡ profile.html å®Œå…¨ç›¸åŒï¼‰ ===
function getKnightLevel(trustScore) {
  if (trustScore >= 90) {
    return {
      name: "é‘½çŸ³é¨å£«",
      emoji: "ğŸ’",
      badgeClass: "bg-emerald-500 text-white",
    };
  } else if (trustScore >= 70) {
    return {
      name: "é»ƒé‡‘é¨å£«",
      emoji: "ğŸ¥‡",
      badgeClass: "bg-amber-400 text-slate-900",
    };
  } else if (trustScore >= 40) {
    return {
      name: "é¨å£«",
      emoji: "ğŸ›¡ï¸",
      badgeClass: "bg-sky-500 text-white",
    };
  } else if (trustScore >= 20) {
    return {
      name: "é¨å£«å­¸å¾’",
      emoji: "ğŸ”°",
      badgeClass: "bg-slate-500 text-white",
    };
  } else {
    return {
      name: "é¨å£«è¦‹ç¿’",
      emoji: "ğŸŒ±",
      badgeClass: "bg-slate-600 text-white",
    };
  }
}


  // å¹«æŒ‡å®š user ç®—å‡ºä¿¡ä»»åº¦ï¼ˆ0ï½100 åˆ†ï¼‰ï¼Œè³‡æ–™ä¾†æºï¼štask_reviews
  async function fetchTrustScoreForUser(userId) {
    if (!userId) return null;

    const reviewsRef = collection(db, "task_reviews");
    const qReviews = query(reviewsRef, where("toUserId", "==", userId));
    const snap = await getDocs(qReviews);

    let total = 0;
    let count = 0;

    snap.forEach((docSnap) => {
      const d = docSnap.data();
      if (typeof d.rating === "number") {
        total += d.rating;
        count++;
      }
    });

    if (!count) {
      // æ²’æœ‰è¢«è©•åƒ¹éï¼Œå›å‚³ nullï¼Œä»£è¡¨ã€Œæ–°æ‰‹ã€
      return null;
    }

    const avg = total / count; // 0~5
    const trustScore = Math.round((avg / 5) * 100); // 0~100
    return trustScore;
  }

  function renderKnightBadge(el, trustScore) {
  if (!el) return;

  // â­ æ²’æœ‰ä»»ä½•è©•åƒ¹ â†’ é¡¯ç¤ºã€Œé¨å£«è¦‹ç¿’ã€
  if (trustScore == null) {
    el.innerHTML = `
      <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[11px] font-medium bg-slate-600 text-white">
        <span>ğŸŒ±</span>
        <span>é¨å£«è¦‹ç¿’</span>
      </span>
    `;
    return;
  }

  // â­ å–å¾—æ­£å¼é¨å£«ç­‰ç´šè³‡è¨Šï¼ˆèˆ‡ profile.html å®Œå…¨ä¸€è‡´ï¼‰
  const level = getKnightLevel(trustScore);

  // â­ è¼¸å‡ºå¾½ç« ï¼ˆèƒŒæ™¯é¡è‰² + emoji + åç¨±ï¼‰
  el.innerHTML = `
    <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[11px] font-medium ${level.badgeClass}">
      <span>${level.emoji}</span>
      <span>${level.name}</span>
    </span>
  `;
}


  async function updateKnightBadges() {
    if (!currentTask) return;

    try {
      // ç™¼å–®è€…
      if (currentTask.creatorId && creatorKnightLevelEl) {
        const ts = await fetchTrustScoreForUser(currentTask.creatorId);
        renderKnightBadge(creatorKnightLevelEl, ts);
      }

      // æ¥å–®è€…ï¼ˆå¯èƒ½é‚„æ²’æœ‰äººæ¥ï¼‰
      if (currentTask.takerId && takerKnightLevelEl) {
        const ts = await fetchTrustScoreForUser(currentTask.takerId);
        renderKnightBadge(takerKnightLevelEl, ts);
      } else if (takerKnightLevelEl) {
        takerKnightLevelEl.textContent = ""; // é‚„æ²’æœ‰äººæ¥å°±ä¸é¡¯ç¤º
      }
    } catch (err) {
      console.error("updateKnightBadges error:", err);
    }
  }

  // æ¸²æŸ“ä»»å‹™å…§å®¹
  function renderTask() {
    if (!currentTask) return;
    const data = currentTask;

    // ç‹€æ…‹é¡¯ç¤º
    const statusText =
      data.status === "open"      ? "é–‹æ”¾ä¸­" :
      data.status === "accepted"  ? "å·²æœ‰äººæ¥" :
      data.status === "completed" ? "å·²å®Œæˆ" :
      data.status === "expired"   ? "å·²éæœŸ" :
      "ç‹€æ…‹ä¸æ˜";

    const statusColorClass =
      data.status === "open"      ? "text-emerald-500" :
      data.status === "accepted"  ? "text-amber-500" :
      data.status === "completed" ? "text-indigo-500" :
      data.status === "expired"   ? "text-slate-500" :
      "text-slate-500";

    const dotColorClass =
      data.status === "open"      ? "bg-emerald-400" :
      data.status === "accepted"  ? "bg-amber-400" :
      data.status === "completed" ? "bg-indigo-400" :
      data.status === "expired"   ? "bg-slate-400" :
      "bg-slate-300";

    statusLabelEl.textContent = `ã€${statusText}ã€‘`;
    statusLabelEl.className =
      "text-xs font-semibold tracking-wide " + statusColorClass;
    statusDotEl.className =
      "w-2.5 h-2.5 rounded-full " + dotColorClass;

    // æ¨™é¡Œ
    titleEl.textContent = data.title || "(ç„¡æ¨™é¡Œ)";

    // é¡åˆ¥ / é…¬å‹ / æˆªæ­¢ / ç™¼å¸ƒ
    categoryChipEl.textContent = `é¡åˆ¥ï¼š${getCategoryLabel(data.category)}`;

        // é…¬å‹ï¼ˆé˜² XSSï¼šä¸å¡é€² innerHTMLï¼‰
    const safeReward =
      data.reward && String(data.reward).trim()
        ? String(data.reward).trim().slice(0, 50)   // é™åˆ¶æœ€å¤š 50 å­—
        : "æœªå¡«å¯«";
    rewardEl.textContent = `ğŸ’° é…¬å‹ï¼š${safeReward}`;

    // æˆªæ­¢æ—¥æœŸï¼ˆé€™å…©å€‹å…¶å¯¦ä¸æœƒ XSSï¼Œä½†é †ä¾¿çµ±ä¸€ç”¨ textContentï¼‰
    const deadlineDate = toJsDate(data.deadline);
    const deadlineStr = deadlineDate ? formatDate(deadlineDate) : "æœªè¨­å®š";
    deadlineEl.textContent = `â° æˆªæ­¢æ—¥æœŸï¼š${deadlineStr}`;

    const createdDate = toJsDate(data.createdAt);
    const createdStr = createdDate ? formatDate(createdDate) : "æœªçŸ¥";
    createdAtEl.textContent = `ğŸ•’ ç™¼å¸ƒæ™‚é–“ï¼š${createdStr}`;


    // ç™¼å–® / æ¥å–®è€…
    creatorNicknameEl.textContent = data.creatorNickname || "æœªçŸ¥";
    takerNicknameEl.textContent = data.takerNickname || "å°šæœªæœ‰äººæ¥å–®";

    // èªªæ˜
    const desc = (data.description || "").trim();
    descriptionEl.textContent = desc || "ï¼ˆç™¼å–®è€…æœªå¡«å¯«èªªæ˜ï¼‰";
    
    // æŒ‰éˆ•é¡¯ç¤º
    updateActionButtons();
    updateKnightBadges();
  }

  // è®€å–ä»»å‹™çš„è©•åƒ¹
  async function loadReviews() {
    if (!currentUser || !currentTask) return;

    const isParticipant =
      currentTask.creatorId === currentUser.uid ||
      currentTask.takerId === currentUser.uid;
    if (!isParticipant) return;

    const reviewsRef = collection(db, "task_reviews");
    const q = query(reviewsRef, where("taskId", "==", currentTask.id));
    const snap = await getDocs(q);

    myReview = null;
    otherReview = null;

    snap.forEach((docSnap) => {
      const d = docSnap.data();
      if (d.fromUserId === currentUser.uid) {
        myReview = { id: docSnap.id, ...d };
      } else if (d.toUserId === currentUser.uid) {
        otherReview = { id: docSnap.id, ...d };
      }
    });

    renderReviews();
  }

  // æ ¹æ“š currentTask / è©•åƒ¹ç‹€æ…‹æ±ºå®šç•«é¢
  function renderReviews() {
    if (!currentUser || !currentTask) return;

    const isParticipant =
      currentTask.creatorId === currentUser.uid ||
      currentTask.takerId === currentUser.uid;
    const isCompleted = currentTask.status === "completed";

    if (!isParticipant || !isCompleted) {
      reviewSection?.classList.add("hidden");
      return;
    }

    reviewSection?.classList.remove("hidden");

    // æˆ‘çµ¦å°æ–¹çš„
    if (myReview) {
      reviewForm?.classList.add("hidden");
      myReviewBox?.classList.remove("hidden");
      const stars = "â˜…".repeat(myReview.rating);
      myReviewBox.textContent =
        `ä½ çµ¦å°æ–¹çš„è©•åƒ¹ï¼š${stars}ï¼ˆ${myReview.rating} / 5ï¼‰` +
        (myReview.comment ? ` ${myReview.comment}` : "");
    } else {
      reviewForm?.classList.remove("hidden");
      myReviewBox?.classList.add("hidden");
    }

    // å°æ–¹çµ¦æˆ‘çš„
    if (otherReview) {
      otherReviewBox?.classList.remove("hidden");
      const who =
        currentTask.creatorId === currentUser.uid
          ? currentTask.takerNickname || "æ¥å–®è€…"
          : currentTask.creatorNickname || "ç™¼å–®è€…";
      const stars = "â˜…".repeat(otherReview.rating);
      otherReviewBox.textContent =
        `${who} çµ¦ä½ çš„è©•åƒ¹ï¼š${stars}ï¼ˆ${otherReview.rating} / 5ï¼‰` +
        (otherReview.comment ? ` ${otherReview.comment}` : "");
    } else {
      otherReviewBox?.classList.add("hidden");
    }
  }

  // æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯
  function updateActionButtons() {
    acceptBtn.classList.add("hidden");
    chatBtn.classList.add("hidden");
    completeBtn.classList.add("hidden");

    if (!currentUser || !currentTask) return;

    const status = currentTask.status || "open";
    const isCreator =
      String(currentTask.creatorId || "") === String(currentUser.uid || "");
    const isTaker =
      String(currentTask.takerId || "") === String(currentUser.uid || "");

    // æ¥å–®
    if (status === "open" && !isCreator) {
      acceptBtn.classList.remove("hidden");
    }

    // èŠå¤©å®¤ï¼šåªåœ¨ accepted + ä»»å‹™é›™æ–¹
    if (status === "accepted" && (isCreator || isTaker)) {
      chatBtn.classList.remove("hidden");
    }

    // æ¨™è¨˜å®Œæˆï¼šåªåœ¨ accepted + ç™¼å–®è€…
    if (status === "accepted" && isCreator) {
      completeBtn.classList.remove("hidden");
    }
  }

  // æ¥å–®
  async function acceptTask() {
    if (!currentUser || !currentUserProfile || !currentTask) return;

    const ok = confirm("ç¢ºå®šè¦æ¥ä¸‹é€™å€‹ä»»å‹™å—ï¼Ÿ");
    if (!ok) return;

    try {
      const taskRef = doc(db, "tasks", currentTask.id);
      await updateDoc(taskRef, {
        status: "accepted",
        takerId: currentUser.uid,
        takerNickname: currentUserProfile.nickname
      });

      detailMessageEl.textContent = "æ¥å–®æˆåŠŸï¼";
      await loadTaskFromServer();
    } catch (err) {
      console.error(err);
      alert("æ¥å–®å¤±æ•—ï¼š" + err.message);
    }
  }

  // æ¨™è¨˜å®Œæˆ
  async function completeTask() {
    if (!currentUser || !currentTask) return;

    const ok = confirm("ç¢ºå®šè¦å°‡é€™å€‹ä»»å‹™æ¨™è¨˜ç‚ºå·²å®Œæˆå—ï¼Ÿ");
    if (!ok) return;

    try {
      const taskRef = doc(db, "tasks", currentTask.id);
      await updateDoc(taskRef, {
        status: "completed"
      });

      detailMessageEl.textContent = "å·²å°‡ä»»å‹™æ¨™è¨˜ç‚ºå®Œæˆï¼";
      await loadTaskFromServer();
    } catch (err) {
      console.error(err);
      alert("æ¨™è¨˜å®Œæˆå¤±æ•—ï¼š" + err.message);
    }
  }

  // æ‰“é–‹èŠå¤©å®¤
  function openChat() {
    if (!currentTask) return;
    window.location.href =
      `chat.html?taskId=${encodeURIComponent(currentTask.id)}`;
  }

  acceptBtn.addEventListener("click", acceptTask);
  completeBtn.addEventListener("click", completeTask);
  chatBtn.addEventListener("click", openChat);

  // è®€å–ä»»å‹™
  async function loadTaskFromServer() {
    if (!taskId) return;
    detailMessageEl.textContent = "è®€å–ä»»å‹™ä¸­â€¦";

    try {
      const taskRef = doc(db, "tasks", taskId);
      const snap = await getDoc(taskRef);

      if (!snap.exists()) {
        alert("æ‰¾ä¸åˆ°é€™å€‹ä»»å‹™ã€‚");
        window.location.href = "tasks.html";
        return;
      }

      currentTask = { id: snap.id, ...snap.data() };

      // è‡ªå‹•åˆ¤æ–·æ˜¯å¦éæœŸï¼ˆopen + deadline < now â†’ expiredï¼‰
      const deadlineDate = currentTask.deadline?.toDate?.() ?? null;
      const now = new Date();
      if (
        currentTask.status === "open" &&
        deadlineDate &&
        deadlineDate < now
      ) {
        await updateDoc(taskRef, { status: "expired" });
        currentTask.status = "expired";
      }

      renderTask();
      // æ¸²æŸ“å®ŒæŒ‰éˆ•å¾Œå†è®€å–è©•åƒ¹
      await loadReviews();
    } catch (err) {
      console.error(err);
      detailMessageEl.textContent = "è¼‰å…¥ä»»å‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    }
  }

  // è©•åƒ¹é€å‡º
  reviewForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    reviewMsg.textContent = "";
    reviewMsg.style.color = "red";

    if (!currentUser || !currentTask) return;

    let rating = null;
    reviewStarInputs.forEach((input) => {
      if (input.checked) rating = Number(input.value);
    });

    if (!rating) {
      reviewMsg.textContent = "è«‹å…ˆé¸æ“‡ä¸€å€‹è©•åˆ†ã€‚";
      return;
    }

    const comment = reviewComment.value.trim();

    const toUserId =
      currentTask.creatorId === currentUser.uid
        ? currentTask.takerId
        : currentTask.creatorId;

    if (!toUserId) {
      reviewMsg.textContent = "æ‰¾ä¸åˆ°è©•åƒ¹å°è±¡ã€‚";
      return;
    }

    try {
      await addDoc(collection(db, "task_reviews"), {
        taskId: currentTask.id,
        fromUserId: currentUser.uid,
        toUserId,
        rating,
        comment,
        createdAt: new Date()
      });

      reviewMsg.style.color = "lime";
      reviewMsg.textContent = "å·²é€å‡ºè©•åƒ¹ï¼";
      await loadReviews();
    } catch (err) {
      console.error(err);
      reviewMsg.textContent = "é€å‡ºè©•åƒ¹å¤±æ•—ï¼š" + err.message;
    } finally {
      setTimeout(() => {
        reviewMsg.textContent = "";
        reviewMsg.style.color = "red";
      }, 2000);
    }
  });

  // ç™»å…¥ç‹€æ…‹
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
// å…±ç”¨ï¼šæª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦è¢«å°é–
async function enforceBanIfNeeded(user) {
  try {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) return false;

    const data = snap.data();
    if (data.isBanned) {
      const reason =
        data.banReason ||
        "ä½ çš„å¸³è™Ÿå·²è¢«ç®¡ç†å“¡å°é–ï¼Œå¦‚æœ‰ç–‘å•è«‹å‘è€å¸«æˆ–ç®¡ç†å“¡è©¢å•ã€‚";

      alert(`å¸³è™Ÿå·²è¢«å°é–ï¼š\n${reason}`);

      try {
        // æŠŠåŸå› æš«å­˜ä¸‹ä¾†ï¼Œç­‰ç­‰åœ¨ login é é¢é¡¯ç¤º
        localStorage.setItem("lastBanReason", reason);
      } catch (e) {
        console.error("å„²å­˜å°é–åŸå› å¤±æ•—ï¼š", e);
      }

      await signOut(auth);
      // åŠ ä¸Š ?banned=1 è®“ login.html çŸ¥é“è¦é¡¯ç¤ºå°é–è¨Šæ¯
      window.location.href = "login.html?banned=1";
      return true;
    }

    return false;
  } catch (err) {
    console.error("æª¢æŸ¥å°é–ç‹€æ…‹å¤±æ•—ï¼š", err);
    // å‡ºéŒ¯å°±ç•¶ä½œæ²’å°é–ï¼Œé¿å…ä¸€ç›´å¡åœ¨é€™è£¡
    return false;
  }
}

    currentUser = user;

    try {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        userInfoEl.textContent = "æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™";
        return;
      }

      currentUserProfile = snap.data();
      userInfoEl.textContent =
        `æ­¡è¿ï¼Œ${currentUserProfile.nickname}ï¼ˆ${currentUserProfile.schoolName || ""}ï¼‰`;

      await loadTaskFromServer();
    } catch (err) {
      console.error(err);
      userInfoEl.textContent = "è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤";
    }
  });

  // æ‰‹æ©Ÿåº•éƒ¨å°è¦½åˆ—ï¼šé«˜äº®
  (() => {
    const file = window.location.pathname.split("/").pop() || "tasks.html";
    const map = {
      "tasks.html": "tasks",
      "task_detail.html": "tasks",
      "my_tasks.html": "my_tasks",
      "chat.html": "my_tasks",
      "profile.html": "profile"
    };
    const activeKey = map[file] || "tasks";
    document.querySelectorAll("[data-bottom-item]").forEach((el) => {
      const key = el.getAttribute("data-bottom-item");
      if (key === activeKey) {
        el.classList.remove("text-slate-400");
        el.classList.add("text-indigo-400", "font-semibold");
      }
    });
  })();
</script>
<p class="text-[11px] text-slate-500 mt-6 text-center">
  æœ¬å¹³å°åƒ…ä¾›æ ¡å…§ä»»å‹™åª’åˆä½¿ç”¨ï¼Œæ‰€æœ‰è³‡æ–™åƒ…ä½œç‚ºä»»å‹™ç®¡ç†åŠè¯ç¹«ç”¨é€”ï¼Œä¸æœƒå°å¤–å…¬é–‹æˆ–æä¾›çµ¦ç¬¬ä¸‰æ–¹ã€‚
</p>
</body>
</html>
