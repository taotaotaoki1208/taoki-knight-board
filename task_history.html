<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.ico">
  <title>歷史紀錄 - 陶吉騎士團任務板</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-slate-900 text-slate-800">
<div class="min-h-screen flex flex-col">
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <!-- 左側 Logo + 標題 -->
    <div class="flex items-center gap-3">
      <div
        class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-amber-400 text-sm font-extrabold text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center">
        陶
      </div>
      <div>
        <div class="text-sm font-semibold text-slate-100">
          陶吉騎士團任務板
        </div>
        <div class="text-xs text-slate-400">
          校園互助任務平台
        </div>
      </div>
    </div>

    <!-- 右側：桌機導覽 + 使用者資訊 + 登出 -->
    <div class="flex items-center gap-3 text-sm">
      <!-- 電腦版導覽列 -->
      <nav class="hidden sm:flex items-center gap-2">
        <!-- 任務廣場 -->
        <a
          href="tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navTasks"
        >
          任務廣場
        </a>

        <!-- 我的任務 -->
        <a
          href="my_tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navMyTasks"
        >
          我的任務
        </a>

        <!-- 歷史紀錄 -->
        <a
          href="task_history.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navHistory"
        >
          歷史紀錄
        </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  公告
</a>
        <!-- 個人資料 -->
        <a
          href="profile.html"
          class="rounded-full bg-indigo-500 px-3 py-1 text-xs font-medium text-white shadow hover:bg-indigo-400"
          id="navProfile"
        >
          個人資料
        </a>
      </nav>

      <!-- 使用者暱稱 / 學校（如果有） -->
      <span
        id="userInfo"
        class="hidden sm:inline text-xs text-slate-300 max-w-[160px] truncate text-right"
      ></span>

      <!-- 登出按鈕 -->
      <button
        id="logoutBtn"
        class="px-3 py-1 rounded-full text-xs border border-slate-600 text-slate-200 hover:bg-slate-800/80"
      >
        登出
      </button>
    </div>
    <!-- 手機底部導覽列（小螢幕） -->
<div
  class="fixed bottom-0 inset-x-0 sm:hidden bg-slate-950/95 backdrop-blur border-t border-slate-800 flex justify-around py-2 text-[11px] text-slate-300 z-20"
>
  <a
    href="tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavTasks"
  >
    <span>任務</span>
    <!-- 小圓點：預設隱藏，在哪一頁就改那一個的 opacity -->
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="my_tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavMyTasks"
  >
    <span>我的</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="task_history.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavHistory"
  >
    <span>歷史</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  公告
</a>
  <a
    href="profile.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavProfile"
  >
    <span>資料</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
</div>

  </div>
</header>


  <!-- 內容 -->
  <main class="flex-1 px-4 py-6">
    <div class="max-w-5xl mx-auto space-y-4">
      <h1 class="text-lg font-semibold text-slate-100 mb-2">歷史紀錄</h1>
      <p class="text-xs text-slate-400">
        這裡只會顯示 <span class="font-semibold">已接單、已完成或已過期</span> 的任務紀錄，公開任務仍在「任務廣場」中顯示。
      </p>

      <div class="grid gap-4 md:grid-cols-2">
        <!-- 我發出的歷史任務 -->
        <section class="rounded-2xl bg-slate-950/80 border border-slate-800 p-4">
          <h2 class="text-sm font-semibold text-slate-100 mb-2">
            我發出的歷史任務
          </h2>
          <ul id="historyCreatedList" class="space-y-2 text-xs text-slate-100">
            <li class="text-slate-400 text-[11px]">載入中…</li>
          </ul>
        </section>

        <!-- 我接到的歷史任務 -->
        <section class="rounded-2xl bg-slate-950/80 border border-slate-800 p-4">
          <h2 class="text-sm font-semibold text-slate-100 mb-2">
            我接到的歷史任務
          </h2>
          <ul id="historyTakenList" class="space-y-2 text-xs text-slate-100">
            <li class="text-slate-400 text-[11px]">載入中…</li>
          </ul>
        </section>
      </div>
    </div>
  </main>
</div>

<script type="module">
  import {
    initializeApp,
    getApp,
    getApps
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGbRsMSuSoW4rx11n6T1Kz8KyLTRqzHvU",
    authDomain: "taoki-knight-board.firebaseapp.com",
    projectId: "taoki-knight-board",
    storageBucket: "taoki-knight-board.firebasestorage.app",
    messagingSenderId: "319225747276",
    appId: "1:319225747276:web:5556b601dca17e760121e9"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userInfoEl = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");
  const historyCreatedList = document.getElementById("historyCreatedList");
  const historyTakenList = document.getElementById("historyTakenList");

  let currentUser = null;

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  function statusLabel(status) {
    if (status === "accepted") return "已接單";
    if (status === "completed") return "已完成";
    if (status === "expired") return "已過期";
    return status || "未知";
  }

  function statusColor(status) {
    if (status === "accepted") return "text-amber-400";
    if (status === "completed") return "text-indigo-400";
    if (status === "expired") return "text-slate-400";
    return "text-slate-300";
  }

  async function loadUserInfo(user) {
    try {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        const profile = snap.data();
        userInfoEl.textContent =
          `${profile.nickname || "(未設定暱稱)"}（${profile.schoolName || ""}）`;
      }
    } catch (err) {
      console.error("載入使用者資料失敗：", err);
    }
  }

  async function loadHistory() {
    if (!currentUser) return;

    historyCreatedList.innerHTML =
      '<li class="text-slate-400 text-[11px]">載入中…</li>';
    historyTakenList.innerHTML =
      '<li class="text-slate-400 text-[11px]">載入中…</li>';

    const tasksRef = collection(db, "tasks");

    // 我發出的
    const qCreated = query(tasksRef, where("creatorId", "==", currentUser.uid));
    const snapCreated = await getDocs(qCreated);

    const created = [];
    snapCreated.forEach((docSnap) => {
      const d = docSnap.data();
      if (d.status !== "open") {
        created.push({ id: docSnap.id, ...d });
      }
    });

    // 我接到的
    const qTaken = query(tasksRef, where("takerId", "==", currentUser.uid));
    const snapTaken = await getDocs(qTaken);

    const taken = [];
    snapTaken.forEach((docSnap) => {
      const d = docSnap.data();
      if (d.status !== "open") {
        taken.push({ id: docSnap.id, ...d });
      }
    });

    // 排序：用 createdAt 由新到舊
    const sortByCreatedAtDesc = (a, b) => {
      const da = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
      const db = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
      return db - da;
    };

    created.sort(sortByCreatedAtDesc);
    taken.sort(sortByCreatedAtDesc);

    // 渲染「我發出的歷史任務」
    historyCreatedList.innerHTML = "";
    if (created.length === 0) {
      historyCreatedList.innerHTML =
        '<li class="text-slate-400 text-[11px]">目前還沒有歷史紀錄。</li>';
    } else {
      created.forEach((t) => {
        const li = document.createElement("li");
        li.className =
          "rounded-xl bg-slate-900/80 border border-slate-800 px-3 py-2";

        const title = document.createElement("div");
        title.className = "text-xs font-semibold text-slate-100";
        title.textContent = t.title || "(未命名任務)";
        li.appendChild(title);

        const info = document.createElement("div");
        info.className = "mt-1 text-[11px] text-slate-400";
        info.textContent = `接單者：${t.takerNickname || "（尚未接單或未知）"}`;
        li.appendChild(info);

        const status = document.createElement("div");
        status.className = "mt-1 text-[11px] " + statusColor(t.status);
        status.textContent = `狀態：${statusLabel(t.status)}`;
        li.appendChild(status);

        const btn = document.createElement("button");
        btn.textContent = "查看詳情";
        btn.className =
          "mt-2 px-3 py-1 rounded bg-slate-800 text-[11px] text-white hover:bg-slate-700";
        btn.addEventListener("click", () => {
          window.location.href = `task_detail.html?taskId=${t.id}`;
        });
        li.appendChild(btn);

        historyCreatedList.appendChild(li);
      });
    }

    // 渲染「我接到的歷史任務」
    historyTakenList.innerHTML = "";
    if (taken.length === 0) {
      historyTakenList.innerHTML =
        '<li class="text-slate-400 text-[11px]">目前還沒有歷史紀錄。</li>';
    } else {
      taken.forEach((t) => {
        const li = document.createElement("li");
        li.className =
          "rounded-xl bg-slate-900/80 border border-slate-800 px-3 py-2";

        const title = document.createElement("div");
        title.className = "text-xs font-semibold text-slate-100";
        title.textContent = t.title || "(未命名任務)";
        li.appendChild(title);

        const info = document.createElement("div");
        info.className = "mt-1 text-[11px] text-slate-400";
        info.textContent = `發單者：${t.creatorNickname || "未知"}`;
        li.appendChild(info);

        const status = document.createElement("div");
        status.className = "mt-1 text-[11px] " + statusColor(t.status);
        status.textContent = `狀態：${statusLabel(t.status)}`;
        li.appendChild(status);

        const btn = document.createElement("button");
        btn.textContent = "查看詳情";
        btn.className =
          "mt-2 px-3 py-1 rounded bg-slate-800 text-[11px] text-white hover:bg-slate-700";
        btn.addEventListener("click", () => {
          window.location.href = `task_detail.html?taskId=${t.id}`;
        });
        li.appendChild(btn);

        historyTakenList.appendChild(li);
      });
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    // 共用：檢查使用者是否被封鎖
async function enforceBanIfNeeded(user) {
  try {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) return false;

    const data = snap.data();
    if (data.isBanned) {
      const reason =
        data.banReason ||
        "你的帳號已被管理員封鎖，如有疑問請向老師或管理員詢問。";

      alert(`帳號已被封鎖：\n${reason}`);

      try {
        // 把原因暫存下來，等等在 login 頁面顯示
        localStorage.setItem("lastBanReason", reason);
      } catch (e) {
        console.error("儲存封鎖原因失敗：", e);
      }

      await signOut(auth);
      // 加上 ?banned=1 讓 login.html 知道要顯示封鎖訊息
      window.location.href = "login.html?banned=1";
      return true;
    }

    return false;
  } catch (err) {
    console.error("檢查封鎖狀態失敗：", err);
    // 出錯就當作沒封鎖，避免一直卡在這裡
    return false;
  }
}

    currentUser = user;
    await loadUserInfo(user);
    await loadHistory();
  });
</script>
<p class="text-[11px] text-slate-500 mt-6 text-center">
  本平台僅供校內任務媒合使用，所有資料僅作為任務管理及聯繫用途，不會對外公開或提供給第三方。
</p>
</body>
</html>
