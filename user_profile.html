<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.ico">
  <title>é¨å£«è³‡æ–™ - é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pageBg: "#020617"
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-pageBg text-slate-100">
<div class="min-h-screen flex flex-col">
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <!-- å·¦å´ Logo + æ¨™é¡Œ -->
    <div class="flex items-center gap-3">
      <div
        class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-amber-400 text-sm font-extrabold text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center">
        é™¶
      </div>
      <div>
        <div class="text-sm font-semibold text-slate-100">
          é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿
        </div>
        <div class="text-xs text-slate-400">
          æ ¡åœ’äº’åŠ©ä»»å‹™å¹³å°
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šæ¡Œæ©Ÿå°è¦½ + ä½¿ç”¨è€…è³‡è¨Š + ç™»å‡º -->
    <div class="flex items-center gap-3 text-sm">
      <!-- é›»è…¦ç‰ˆå°è¦½åˆ— -->
      <nav class="hidden sm:flex items-center gap-2">
        <!-- ä»»å‹™å»£å ´ -->
        <a
          href="tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navTasks"
        >
          ä»»å‹™å»£å ´
        </a>

        <!-- æˆ‘çš„ä»»å‹™ -->
        <a
          href="my_tasks.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navMyTasks"
        >
          æˆ‘çš„ä»»å‹™
        </a>

        <!-- æ­·å²ç´€éŒ„ -->
        <a
          href="task_history.html"
          class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
          id="navHistory"
        >
          æ­·å²ç´€éŒ„
        </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  å…¬å‘Š
</a>
        <!-- å€‹äººè³‡æ–™ -->
        <a
          href="profile.html"
          class="rounded-full bg-indigo-500 px-3 py-1 text-xs font-medium text-white shadow hover:bg-indigo-400"
          id="navProfile"
        >
          å€‹äººè³‡æ–™
        </a>
      </nav>

      <!-- ä½¿ç”¨è€…æš±ç¨± / å­¸æ ¡ï¼ˆå¦‚æœæœ‰ï¼‰ -->
      <span
        id="userInfo"
        class="hidden sm:inline text-xs text-slate-300 max-w-[160px] truncate text-right"
      ></span>

      <!-- ç™»å‡ºæŒ‰éˆ• -->
      <button
        id="logoutBtn"
        class="px-3 py-1 rounded-full text-xs border border-slate-600 text-slate-200 hover:bg-slate-800/80"
      >
        ç™»å‡º
      </button>
    </div>
    <!-- æ‰‹æ©Ÿåº•éƒ¨å°è¦½åˆ—ï¼ˆå°è¢å¹•ï¼‰ -->
<div
  class="fixed bottom-0 inset-x-0 sm:hidden bg-slate-950/95 backdrop-blur border-t border-slate-800 flex justify-around py-2 text-[11px] text-slate-300 z-20"
>
  <a
    href="tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavTasks"
  >
    <span>ä»»å‹™</span>
    <!-- å°åœ“é»ï¼šé è¨­éš±è—ï¼Œåœ¨å“ªä¸€é å°±æ”¹é‚£ä¸€å€‹çš„ opacity -->
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="my_tasks.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavMyTasks"
  >
    <span>æˆ‘çš„</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>

  <a
    href="task_history.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavHistory"
  >
    <span>æ­·å²</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
<a
  href="announcements.html"
  class="px-3 py-1 rounded-full hover:bg-slate-800/70 text-slate-300"
>
  å…¬å‘Š
</a>
  <a
    href="profile.html"
    class="flex flex-col items-center gap-0.5"
    id="mnavProfile"
  >
    <span>è³‡æ–™</span>
    <span class="mt-0.5 h-1 w-1 rounded-full bg-indigo-400 opacity-0"></span>
  </a>
</div>

  </div>
</header>


  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6 space-y-4">
      <button id="backBtn"
              class="mb-2 inline-flex items-center gap-1 text-xs text-slate-400 hover:text-slate-200">
        â† è¿”å›ä»»å‹™è©³æƒ…
      </button>

      <section
        class="rounded-2xl border border-slate-800 bg-slate-900/80 p-5 shadow-xl shadow-slate-950/60">
        <div class="flex items-start gap-4">
          <!-- é ­åƒ -->
          <div
            id="avatarBox"
            class="h-16 w-16 rounded-full bg-slate-800 flex items-center justify-center overflow-hidden text-lg font-semibold text-slate-200"
          >
            ?
          </div>

          <div class="flex-1 space-y-1">
            <h1 id="nicknameText" class="text-xl font-bold text-slate-50">
              è¼‰å…¥ä¸­â€¦
            </h1>
            <p id="schoolText" class="text-xs text-slate-400">
              â€ƒ
            </p>

            <!-- é¨å£«ç­‰ç´š & ä¿¡ä»»åº¦ -->
            <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
              <span id="knightBadge"></span>
              <span id="trustInfo" class="text-slate-300"></span>
            </div>
          </div>
        </div>

        <!-- ç°¡å–®çµ±è¨ˆ -->
        <div class="mt-4 grid gap-3 text-xs text-slate-200 sm:grid-cols-3">
          <div class="rounded-lg bg-slate-800/80 border border-slate-700 px-3 py-2">
            <div class="text-[11px] text-slate-400 mb-1">å®Œæˆä»»å‹™æ•¸</div>
            <div id="completedCount" class="text-lg font-semibold text-emerald-300">â€”</div>
          </div>
          <div class="rounded-lg bg-slate-800/80 border border-slate-700 px-3 py-2">
            <div class="text-[11px] text-slate-400 mb-1">ç™¼å‡ºä»»å‹™æ•¸</div>
            <div id="createdCount" class="text-lg font-semibold text-sky-300">â€”</div>
          </div>
          <div class="rounded-lg bg-slate-800/80 border border-slate-700 px-3 py-2">
            <div class="text-[11px] text-slate-400 mb-1">æ¥åˆ°ä»»å‹™æ•¸</div>
            <div id="takenCount" class="text-lg font-semibold text-amber-300">â€”</div>
          </div>
        </div>
      </section>

      <!-- æœ€è¿‘åˆä½œè©•åƒ¹ -->
      <section
        class="rounded-2xl border border-slate-800 bg-slate-900/80 p-5 shadow-xl shadow-slate-950/60">
        <h2 class="text-sm font-semibold text-slate-100 mb-2">
          æœ€è¿‘çš„åˆä½œè©•åƒ¹ï¼ˆå°é€™ä½é¨å£«ï¼‰
        </h2>
        <div id="reviewSummary" class="text-xs text-slate-400 mb-2">
          è¼‰å…¥ä¸­â€¦
        </div>
        <ul id="reviewList" class="space-y-2 text-xs text-slate-100">
          <!-- JS å¡«å…¥ -->
        </ul>
      </section>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGbRsMSuSoW4rx11n6T1Kz8KyLTRqzHvU",
    authDomain: "taoki-knight-board.firebaseapp.com",
    projectId: "taoki-knight-board",
    storageBucket: "taoki-knight-board.firebasestorage.app",
    messagingSenderId: "319225747276",
    appId: "1:319225747276:web:5556b601dca17e760121e9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const avatarBox = document.getElementById("avatarBox");
  const nicknameText = document.getElementById("nicknameText");
  const schoolText = document.getElementById("schoolText");
  const knightBadgeEl = document.getElementById("knightBadge");
  const trustInfoEl = document.getElementById("trustInfo");
  const completedCountEl = document.getElementById("completedCount");
  const createdCountEl = document.getElementById("createdCount");
  const takenCountEl = document.getElementById("takenCount");
  const reviewSummaryEl = document.getElementById("reviewSummary");
  const reviewListEl = document.getElementById("reviewList");
  const backBtn = document.getElementById("backBtn");

  // å–å¾—ç¶²å€ä¸Šçš„ uid åƒæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const targetUid = urlParams.get("uid");

  if (!targetUid) {
    nicknameText.textContent = "æ‰¾ä¸åˆ°æ­¤é¨å£«ã€‚";
  }

  backBtn.addEventListener("click", () => {
    history.back();
  });

  function formatDate(d) {
    if (!d) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}/${m}/${day}`;
  }

  // èˆ‡ profile.html ä¸€æ¨£çš„é¨å£«ç­‰ç´š
  function getKnightLevel(trustScore) {
    if (trustScore >= 90) {
      return {
        name: "é‘½çŸ³é¨å£«",
        emoji: "ğŸ’",
        badgeClass: "bg-emerald-500 text-white"
      };
    } else if (trustScore >= 70) {
      return {
        name: "é»ƒé‡‘é¨å£«",
        emoji: "ğŸ¥‡",
        badgeClass: "bg-amber-400 text-slate-900"
      };
    } else if (trustScore >= 40) {
      return {
        name: "é¨å£«",
        emoji: "ğŸ›¡ï¸",
        badgeClass: "bg-sky-500 text-white"
      };
    } else if (trustScore >= 20) {
      return {
        name: "é¨å£«å­¸å¾’",
        emoji: "ğŸ”°",
        badgeClass: "bg-slate-500 text-white"
      };
    } else {
      return {
        name: "é¨å£«è¦‹ç¿’",
        emoji: "ğŸŒ±",
        badgeClass: "bg-slate-600 text-white"
      };
    }
  }

  function setAvatarLetter(name) {
    const c = (name || "?").trim().charAt(0) || "?";
    avatarBox.textContent = c;
  }

  function setAvatarImage(src) {
  if (!src) return;
  avatarBox.innerHTML = `
    <img
      src="${src}"
      alt="avatar"
      loading="lazy"
      class="h-full w-full object-cover rounded-full"
    />
  `;
}


  async function loadUserBasic() {
    const userRef = doc(db, "users", targetUid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      nicknameText.textContent = "æ‰¾ä¸åˆ°æ­¤é¨å£«çš„è³‡æ–™ã€‚";
      schoolText.textContent = "";
      return null;
    }

    const data = snap.data();
    const nickname = data.nickname || "(æœªè¨­å®šæš±ç¨±)";
    nicknameText.textContent = nickname;
    schoolText.textContent = data.schoolName || "è¡›é“ä¸­å­¸";

    const avatarData = data.avatarData || data.avatarUrl || null;
    if (avatarData) {
      setAvatarImage(avatarData);
    } else {
      setAvatarLetter(nickname);
    }

    return data;
  }

  async function loadUserReviews() {
    const reviewsRef = collection(db, "task_reviews");
    const qReviews = query(reviewsRef, where("toUserId", "==", targetUid));
    const snap = await getDocs(qReviews);

    if (snap.empty) {
      reviewSummaryEl.textContent = "ç›®å‰é‚„æ²’æœ‰ä»»ä½•åˆä½œè©•åƒ¹ã€‚";
      reviewListEl.innerHTML = "";
      trustInfoEl.textContent = "ä¿¡ä»»åº¦ï¼šå°šæœªè©•åˆ†";
      knightBadgeEl.innerHTML =
        `<span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[11px] font-medium bg-slate-600 text-white">
          <span>ğŸŒ±</span><span>é¨å£«è¦‹ç¿’</span>
         </span>`;
      return { trustScore: null, count: 0 };
    }

    const list = [];
    let total = 0;
    let count = 0;

    snap.forEach((docSnap) => {
      const d = docSnap.data();
      if (typeof d.rating === "number") {
        total += d.rating;
        count++;
      }
      list.push({ id: docSnap.id, ...d });
    });

    if (!count) {
      reviewSummaryEl.textContent = "å°šæœªæœ‰å¯è¨ˆç®—çš„è©•åˆ†ã€‚";
      return { trustScore: null, count: 0 };
    }

    const avg = total / count;
    const trustScore = Math.round((avg / 5) * 100);
    const avgRounded = Math.round(avg * 10) / 10;
    const stars = "â˜…".repeat(Math.round(avg)) +
      "â˜†".repeat(5 - Math.round(avg));

    const level = getKnightLevel(trustScore);
    knightBadgeEl.innerHTML =
      `<span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[11px] font-medium ${level.badgeClass}">
        <span>${level.emoji}</span><span>${level.name}</span>
       </span>`;
    trustInfoEl.textContent =
      `ä¿¡ä»»åº¦ï¼š${trustScore} åˆ†ï½œå¹³å‡è©•åˆ† ${avgRounded} / 5ï¼ˆå…± ${count} ç­†ï¼‰`;

    reviewSummaryEl.textContent = "";

    // æ’åºï¼Œåˆ—å‡ºæœ€è¿‘ 3 ç­†
    list.sort((a, b) => {
      const da = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
      const db = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
      return db - da;
    });

    const latest = list.slice(0, 3);
    reviewListEl.innerHTML = "";
    latest.forEach((r) => {
      const li = document.createElement("li");
      li.className =
        "rounded-lg bg-slate-800/90 border border-slate-700 px-3 py-2";

      const starCount = Math.round(r.rating || 0);
      const starStr = "â˜…".repeat(starCount) + "â˜†".repeat(5 - starCount);
      const dateStr = r.createdAt?.toDate
        ? formatDate(r.createdAt.toDate())
        : "";

      const safeComment = (r.comment || "ï¼ˆå°æ–¹æ²’æœ‰ç•™ä¸‹æ–‡å­—ï¼‰")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      li.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-[13px] text-yellow-400">${starStr}</span>
          <span class="text-[11px] text-slate-500">${dateStr}</span>
        </div>
        <div class="mt-1 text-xs text-slate-100">${safeComment}</div>
      `;
      reviewListEl.appendChild(li);
    });

    return { trustScore, count };
  }

  async function loadUserTaskStats() {
    const tasksRef = collection(db, "tasks");

    const qCreated = query(tasksRef, where("creatorId", "==", targetUid));
    const snapCreated = await getDocs(qCreated);

    const qTaken = query(tasksRef, where("takerId", "==", targetUid));
    const snapTaken = await getDocs(qTaken);

    let created = 0;
    let taken = 0;
    let completed = 0;

    snapCreated.forEach((docSnap) => {
      const d = docSnap.data();
      created++;
      if (d.status === "completed") completed++;
    });

    snapTaken.forEach((docSnap) => {
      const d = docSnap.data();
      taken++;
      if (d.status === "completed") completed++;
    });

    createdCountEl.textContent = created;
    takenCountEl.textContent = taken;
    completedCountEl.textContent = completed;
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    // å…±ç”¨ï¼šæª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦è¢«å°é–
async function enforceBanIfNeeded(user) {
  try {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) return false;

    const data = snap.data();
    if (data.isBanned) {
      const reason =
        data.banReason ||
        "ä½ çš„å¸³è™Ÿå·²è¢«ç®¡ç†å“¡å°é–ï¼Œå¦‚æœ‰ç–‘å•è«‹å‘è€å¸«æˆ–ç®¡ç†å“¡è©¢å•ã€‚";

      alert(`å¸³è™Ÿå·²è¢«å°é–ï¼š\n${reason}`);

      try {
        // æŠŠåŸå› æš«å­˜ä¸‹ä¾†ï¼Œç­‰ç­‰åœ¨ login é é¢é¡¯ç¤º
        localStorage.setItem("lastBanReason", reason);
      } catch (e) {
        console.error("å„²å­˜å°é–åŸå› å¤±æ•—ï¼š", e);
      }

      await signOut(auth);
      // åŠ ä¸Š ?banned=1 è®“ login.html çŸ¥é“è¦é¡¯ç¤ºå°é–è¨Šæ¯
      window.location.href = "login.html?banned=1";
      return true;
    }

    return false;
  } catch (err) {
    console.error("æª¢æŸ¥å°é–ç‹€æ…‹å¤±æ•—ï¼š", err);
    // å‡ºéŒ¯å°±ç•¶ä½œæ²’å°é–ï¼Œé¿å…ä¸€ç›´å¡åœ¨é€™è£¡
    return false;
  }
}

    if (!targetUid) return;

    try {
      await loadUserBasic();
      await Promise.all([
        loadUserReviews(),
        loadUserTaskStats()
      ]);
    } catch (err) {
      console.error(err);
      nicknameText.textContent = "è¼‰å…¥é¨å£«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
    }
  });
</script>
<p class="text-[11px] text-slate-500 mt-6 text-center">
  æœ¬å¹³å°åƒ…ä¾›æ ¡å…§ä»»å‹™åª’åˆä½¿ç”¨ï¼Œæ‰€æœ‰è³‡æ–™åƒ…ä½œç‚ºä»»å‹™ç®¡ç†åŠè¯ç¹«ç”¨é€”ï¼Œä¸æœƒå°å¤–å…¬é–‹æˆ–æä¾›çµ¦ç¬¬ä¸‰æ–¹ã€‚
</p>
</body>
</html>
