<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.ico">
  <title>ç®¡ç†å¾Œå° - é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pageBg: "#020617",
          }
        }
      }
    }
  </script>

  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-pageBg text-slate-100">
<div class="min-h-screen flex flex-col">

  <!-- é ‚éƒ¨å°è¦½ -->
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div
          class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-amber-400 text-sm font-extrabold text-white shadow-lg shadow-indigo-500/40 flex items-center justify-center">
          é™¶
        </div>
        <div>
          <div class="text-sm font-semibold text-slate-100">
            é™¶å‰é¨å£«åœ˜ä»»å‹™æ¿ Â· ç®¡ç†å¾Œå°
          </div>
          <div class="text-xs text-amber-300">
            åªæœ‰ç®¡ç†è€…å¸³è™Ÿå¯é€²å…¥
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 text-xs sm:text-sm">
        <nav class="hidden sm:flex items-center gap-2 text-slate-300">
          <a href="tasks.html" class="px-3 py-1 rounded-full hover:bg-slate-800/70">ä»»å‹™å»£å ´</a>
          <a href="my_tasks.html" class="px-3 py-1 rounded-full hover:bg-slate-800/70">æˆ‘çš„ä»»å‹™</a>
          <a href="task_history.html" class="px-3 py-1 rounded-full hover:bg-slate-800/70">æ­·å²ç´€éŒ„</a>
          <a href="profile.html" class="px-3 py-1 rounded-full hover:bg-slate-800/70">å€‹äººè³‡æ–™</a>
          <a href="reports_admin.html" class="px-3 py-1 rounded-full hover:bg-slate-800/70">
            å›å ±åˆ—è¡¨
          </a>
          <span class="px-3 py-1 rounded-full bg-slate-800/80 text-amber-300 border border-amber-400/40">
            ç®¡ç†å·¥å…·
          </span>
        </nav>

        <span id="adminUserInfo"
              class="hidden sm:inline text-[11px] text-slate-300 max-w-[180px] truncate text-right"></span>

        <button
          id="logoutBtn"
          class="px-3 py-1 rounded-full text-[11px] border border-slate-600 text-slate-200 hover:bg-slate-800/80">
          ç™»å‡º
        </button>
      </div>
    </div>
  </header>

  <!-- å…§å®¹ -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

      <!-- æç¤º -->
      <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 text-xs sm:text-sm">
        <h1 class="text-sm font-semibold text-slate-50 mb-2">
          ç®¡ç†å·¥å…·ç¸½è¦½
        </h1>
        <ul class="list-disc list-inside space-y-1 text-slate-300">
          <li>å°é– / è§£é™¤å°é–ä½¿ç”¨è€…ï¼ˆå¯«å…¥ users.isBannedï¼‰ã€‚</li>
          <li>é‡è¨­ Knight ä¿¡ä»»åˆ†æ•¸ï¼šåˆªé™¤æ‰€æœ‰ã€Œçµ¦é€™ä½ä½¿ç”¨è€…ã€çš„è©•åƒ¹ï¼ˆtask_reviews â†’ toUserIdï¼‰ã€‚</li>
          <li>ä¸‹æ¶ä»»å‹™ï¼šæŠŠä»»å‹™ status æ”¹æˆ <code>removedByAdmin</code>ï¼Œä¸€èˆ¬åˆ—è¡¨ä¸å†é¡¯ç¤ºã€‚</li>
          <li>æŸ¥çœ‹æŒ‡å®šä»»å‹™çš„æ‰€æœ‰èŠå¤©å®¤è¨Šæ¯ï¼ˆmessagesï¼‰ã€‚</li>
        </ul>
      </section>

      <!-- ä½¿ç”¨è€…ç®¡ç† -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            ä½¿ç”¨è€…ç®¡ç†ï¼ˆå°é– / é‡è¨­ Knightï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            ä»¥ Email æˆ– UID æœå°‹
          </span>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <input
            id="userSearchInput"
            type="text"
            class="flex-1 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="è¼¸å…¥ä½¿ç”¨è€… Email æˆ– UID"
          />
          <button
            id="userSearchBtn"
            class="px-3 py-2 rounded-xl bg-indigo-500 text-xs sm:text-sm font-semibold text-white hover:bg-indigo-400">
            æœå°‹ä½¿ç”¨è€…
          </button>
        </div>

        <p id="userSearchMsg" class="text-[11px] text-slate-400 min-h-[1rem]"></p>

        <div id="userResultBox" class="hidden rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-3 text-xs sm:text-sm space-y-2">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div>
              <div class="font-semibold text-slate-50" id="userNicknameLabel"></div>
              <div class="text-[11px] text-slate-400" id="userEmailLabel"></div>
              <div class="text-[11px] text-slate-400" id="userUidLabel"></div>
            </div>
            <div class="text-right text-[11px] text-slate-400" id="userSchoolLabel"></div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <span id="userBanStatusTag"
                  class="inline-flex items-center rounded-full border border-slate-500 px-2 py-0.5 text-[11px] text-slate-300">
              ç‹€æ…‹è¼‰å…¥ä¸­â€¦
            </span>
            <button
              id="banUserBtn"
              class="px-2.5 py-1 rounded-full text-[11px] bg-rose-500/20 text-rose-200 border border-rose-400/60 hover:bg-rose-500/30">
              å°é–æ­¤å¸³è™Ÿ
            </button>
            <button
              id="unbanUserBtn"
              class="px-2.5 py-1 rounded-full text-[11px] bg-emerald-500/20 text-emerald-200 border border-emerald-400/60 hover:bg-emerald-500/30">
              è§£é™¤å°é–
            </button>
            <button
              id="resetTrustBtn"
              class="px-2.5 py-1 rounded-full text-[11px] bg-amber-500/20 text-amber-100 border border-amber-400/60 hover:bg-amber-500/30">
              é‡è¨­ Knight è©•åƒ¹ï¼ˆæ¸…ç©ºçµ¦ä»–çš„è©•åƒ¹ï¼‰
            </button>
          </div>
        </div>
      </section> <!-- â˜… ç®¡ç†å“¡å¤šæ ¡æŸ¥çœ‹æ¨¡å¼è¨­å®š -->
      <section class="rounded-2xl border border-emerald-700/60 bg-emerald-950/40 p-4 text-xs sm:text-sm">
        <h2 class="text-sm font-semibold text-emerald-100 mb-2">
          ç®¡ç†å“¡å¤šæ ¡æŸ¥çœ‹æ¨¡å¼
        </h2>
        <p class="text-emerald-100 mb-2">
          é–‹å•Ÿå¾Œï¼Œã€Œä»»å‹™å»£å ´ / æˆ‘çš„ä»»å‹™ã€ç­‰é é¢æœƒé¡¯ç¤º<span class="font-semibold">æ‰€æœ‰å­¸æ ¡</span>çš„ä»»å‹™ï¼Œ
          è€Œä¸åªæ˜¯ä¸€å€‹ schoolIdã€‚åªæœƒå°ç®¡ç†å“¡å¸³è™Ÿç”Ÿæ•ˆã€‚
        </p>
        <label class="inline-flex items-center gap-2 text-[11px] text-emerald-100">
          <input
            id="multiSchoolToggle"
            type="checkbox"
            class="rounded border-emerald-400 bg-emerald-900"
          />
          å•Ÿç”¨å¤šæ ¡æŸ¥çœ‹æ¨¡å¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰å­¸æ ¡ï¼‰
        </label>
        <p id="multiSchoolMsg" class="mt-2 text-[11px] text-emerald-300 min-h-[1.2rem]"></p>
      </section>
      <!-- ä»»å‹™ç®¡ç† -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            ä»»å‹™ç®¡ç†ï¼ˆä¸‹æ¶ä»»å‹™ï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            ä»¥ä»»å‹™ ID æœå°‹
          </span>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <input
            id="taskSearchInput"
            type="text"
            class="flex-1 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="è¼¸å…¥ä»»å‹™ IDï¼ˆç¶²å€ä¸Šçš„ ?id=xxx é‚£ä¸²ï¼‰"
          />
          <button
            id="taskSearchBtn"
            class="px-3 py-2 rounded-xl bg-indigo-500 text-xs sm:text-sm font-semibold text-white hover:bg-indigo-400">
            æœå°‹ä»»å‹™
          </button>
        </div>

        <p id="taskSearchMsg" class="text-[11px] text-slate-400 min-h-[1rem]"></p>

        <div id="taskResultBox" class="hidden rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-3 text-xs sm:text-sm space-y-2">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div>
              <div class="font-semibold text-slate-50" id="taskTitleLabel"></div>
              <div class="text-[11px] text-slate-400" id="taskMetaLabel"></div>
            </div>
            <div class="text-right text-[11px] text-slate-400">
              <div id="taskStatusLabel"></div>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button
              id="removeTaskBtn"
              class="px-3 py-1.5 rounded-full text-[11px] bg-rose-500/20 text-rose-100 border border-rose-400/70 hover:bg-rose-500/30">
              å°‡ä»»å‹™æ¨™è¨˜ç‚ºå·²ä¸‹æ¶ï¼ˆstatus = removedByAdminï¼‰
            </button>
          </div>
        </div>
      </section>
       <!-- å®˜æ–¹å…¬å‘Šç®¡ç† -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            å®˜æ–¹å…¬å‘Šç®¡ç†ï¼ˆAnnouncementsï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            ç”±ç®¡ç†å“¡ç™¼å¸ƒï¼Œæ‰€æœ‰ä½¿ç”¨è€…åœ¨å…¬å‘Šé å¯ä»¥çœ‹åˆ°
          </span>
        </div>

        <!-- æ–°å¢å…¬å‘Šè¡¨å–® -->
        <form id="annForm" class="space-y-3 text-xs sm:text-sm text-slate-100">
          <div>
            <label class="block text-[11px] text-slate-400 mb-1">
              å…¬å‘Šæ¨™é¡Œ
            </label>
            <input
              id="annTitle"
              type="text"
              class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm
                     placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="ä¾‹ï¼šç³»çµ±ç¶­è­·é€šçŸ¥ / æ–°åŠŸèƒ½ä¸Šç·š"
              required
            />
          </div>

          <div>
            <label class="block text-[11px] text-slate-400 mb-1">
              å…¬å‘Šå…§å®¹
            </label>
            <textarea
              id="annContent"
              rows="4"
              class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm
                     placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="è«‹è¼¸å…¥è©³ç´°èªªæ˜ï¼Œä¾‹å¦‚ï¼šç¶­è­·æ™‚é–“ã€å½±éŸ¿ç¯„åœã€è¯çµ¡æ–¹å¼â€¦"
              required
            ></textarea>
          </div>

          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-[11px] text-slate-300">
              <input id="annImportant" type="checkbox" class="rounded border-slate-600 bg-slate-900" />
              è¨­ç‚ºé‡è¦å…¬å‘Šï¼ˆåˆ—è¡¨ä¸­æœƒåŠ ä¸Šã€Œé‡è¦ã€æ¨™è¨˜ï¼‰
            </label>

            <button
              type="submit"
              class="px-4 py-1.5 rounded-full text-[11px] font-semibold bg-indigo-500 text-white hover:bg-indigo-400"
            >
              ç™¼å¸ƒå…¬å‘Š
            </button>
          </div>

          <p id="annMsg" class="text-[11px] text-slate-400 min-h-[1.2rem]"></p>
        </form>

        <!-- å…¬å‘Šåˆ—è¡¨ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰ -->
        <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-3 max-h-96 overflow-y-auto">
          <ul id="annList" class="space-y-3 text-xs sm:text-sm">
            <!-- ç”± JS å‹•æ…‹æ’å…¥ -->
          </ul>
        </div>
      </section>
      <!-- å­¸æ ¡ç”³è«‹ç®¡ç† -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            å­¸æ ¡ç”³è«‹ç®¡ç†ï¼ˆschool_requests â†’ schoolsï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            å¯©æ ¸ä½¿ç”¨è€…é€å‡ºçš„ã€Œæ–°å¢å­¸æ ¡ã€ç”³è«‹
          </span>
        </div>

        <p id="schoolReqMsg" class="text-[11px] text-slate-400 min-h-[1.2rem]">
          è¼‰å…¥ä¸­â€¦
        </p>

        <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-3 max-h-96 overflow-y-auto">
          <ul id="schoolReqList" class="space-y-3 text-xs sm:text-sm">
            <!-- ç”± JS å‹•æ…‹æ’å…¥ -->
          </ul>
        </div>

        <p class="text-[11px] text-slate-500">
          æé†’ï¼šç›®å‰æµç¨‹æ˜¯
          <span class="font-semibold text-slate-100">school_requestsï¼ˆä½¿ç”¨è€…ç”³è«‹ï¼‰ â†’ æŒ‰ä¸‹ã€ŒåŠ å…¥ schoolsã€â†’ å»ºç«‹ schools é›†åˆæ–‡ä»¶ â†’ æ›´æ–°ç”³è«‹ç‹€æ…‹</span>ã€‚
          ä¹‹å¾Œ register.html å¯ä»¥æ”¹ç‚ºå¾ <code>schools</code> é›†åˆè¼‰å…¥å­¸æ ¡æ¸…å–®ã€‚
        </p>
      </section>
      <!-- å»ºç«‹ / æ›´æ–°å­¸æ ¡è¨­å®šï¼ˆæ‰‹å‹•å¡«å…¥ â†’ è‡ªå‹•ä¸Šå‚³åˆ° /schoolsï¼‰ -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-3">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            å»ºç«‹ / æ›´æ–°å­¸æ ¡è¨­å®šï¼ˆschoolsï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            å¯©æ ¸å®Œç”³è«‹å¾Œï¼Œåœ¨é€™è£¡æ‰‹å‹•è¼¸å…¥ â†’ è‡ªå‹•å¯«å…¥ Firestore /schools
          </span>
        </div>

        <form id="schoolConfigForm" class="space-y-3 text-xs sm:text-sm text-slate-100">
          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                å­¸æ ¡æ–‡ä»¶ IDï¼ˆå¿…å¡«ï¼Œä¹‹å¾Œè¨»å†Šç”¨çš„ schoolIdï¼‰
              </label>
              <input
                id="cfgSchoolId"
                type="text"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼šweidaoã€taichung1ã€my_school_1"
                required
              />
              <p class="mt-1 text-[10px] text-slate-500">
                å»ºè­°ç”¨è‹±æ–‡å°å¯« + åº•ç·šï¼Œä¸è¦æœ‰ç©ºç™½ã€‚è¨»å†Šæ™‚æœƒç”¨åˆ°é€™å€‹ schoolIdã€‚
              </p>
            </div>

            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                å­¸æ ¡åç¨±ï¼ˆé¡¯ç¤ºç”¨ï¼‰
              </label>
              <input
                id="cfgSchoolName"
                type="text"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼šè¡›é“ä¸­å­¸"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-3">
            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                éƒ¨åˆ¥ keyï¼ˆjunior / senior ...ï¼‰
              </label>
              <input
                id="cfgLevelKey"
                type="text"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼šjunior"
                value="junior"
              />
            </div>

            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                éƒ¨åˆ¥åç¨± label
              </label>
              <input
                id="cfgLevelLabel"
                type="text"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼šåœ‹ä¸­éƒ¨"
                value="åœ‹ä¸­éƒ¨"
              />
            </div>

            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                å­¸è™Ÿå‰ç¶´ codePrefix
              </label>
              <input
                id="cfgCodePrefix"
                type="text"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼šJã€S"
                value="J"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-3">
            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                å¹´ç´šæ•¸ï¼ˆgradeCountï¼‰
              </label>
              <input
                id="cfgGradeCount"
                type="number"
                min="1"
                max="9"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼š3"
              />
            </div>

            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                æ¯å¹´ç´šç­ç´šæ•¸ï¼ˆclassCountï¼‰
              </label>
              <input
                id="cfgClassCount"
                type="number"
                min="1"
                max="40"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼š12"
              />
            </div>

            <div>
              <label class="block text-[11px] text-slate-400 mb-1">
                æ¯ç­æœ€å¤§äººæ•¸ï¼ˆmaxSeatPerClassï¼‰
              </label>
              <input
                id="cfgMaxSeat"
                type="number"
                min="1"
                max="60"
                class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm"
                placeholder="ä¾‹ï¼š40"
              />
            </div>
          </div>

          <div>
            <label class="inline-flex items-center gap-2 text-[11px] text-slate-300">
              <input id="cfgEnabled" type="checkbox" class="rounded border-slate-600 bg-slate-900" checked />
              å•Ÿç”¨é€™é–“å­¸æ ¡ï¼ˆenabled: trueï¼‰
            </label>
          </div>

          <p id="schoolConfigMsg" class="text-[11px] text-slate-400 min-h-[1.2rem]"></p>

          <div class="flex flex-wrap justify-end gap-2">
            <button
              type="button"
              id="fillFromSelectedReqBtn"
              class="px-3 py-1 rounded-full text-[11px] border border-slate-600 text-slate-200 hover:bg-slate-800/80"
            >
              å¾é¸å–çš„ç”³è«‹å¡«å…¥ï¼ˆä¹‹å¾Œå¯åŠ ï¼‰
            </button>
            <button
              type="submit"
              class="px-4 py-1.5 rounded-full text-[11px] font-semibold bg-indigo-500 text-white hover:bg-indigo-400"
            >
              å¯«å…¥ /schoolsï¼ˆå»ºç«‹æˆ–æ›´æ–°ï¼‰
            </button>
          </div>
        </form>
      </section>

      <!-- è¨Šæ¯æª¢è¦– -->
      <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold text-slate-50">
            è¨Šæ¯æª¢è¦–ï¼ˆæŸ¥çœ‹æŸä»»å‹™çš„æ‰€æœ‰èŠå¤©ï¼‰
          </h2>
          <span class="text-[11px] text-slate-400">
            ä»¥ä»»å‹™ ID æœå°‹ messages
          </span>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <input
            id="msgTaskIdInput"
            type="text"
            class="flex-1 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-xs sm:text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="è¼¸å…¥ä»»å‹™ ID"
          />
          <button
            id="loadMessagesBtn"
            class="px-3 py-2 rounded-xl bg-indigo-500 text-xs sm:text-sm font-semibold text-white hover:bg-indigo-400">
            è¼‰å…¥è©²ä»»å‹™æ‰€æœ‰è¨Šæ¯
          </button>
        </div>

        <p id="messagesMsg" class="text-[11px] text-slate-400 min-h-[1rem]"></p>

        <div id="messagesList" class="max-h-80 overflow-y-auto space-y-2 text-xs sm:text-sm">
          <!-- å‹•æ…‹æ’å…¥è¨Šæ¯ -->
        </div>
      </section>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  setDoc,          // â­ æ–°å¢
  collection,
  query,
  where,
  getDocs,
  addDoc,
  onSnapshot,
  orderBy,
  deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";


  const ADMIN_UID = "kQ3myHuzPDOrpUoNZSWv67d5rp72";


  const firebaseConfig = {
    apiKey: "AIzaSyBGbRsMSuSoW4rx11n6T1Kz8KyLTRqzHvU",
    authDomain: "taoki-knight-board.firebaseapp.com",
    projectId: "taoki-knight-board",
    storageBucket: "taoki-knight-board.firebasestorage.app",
    messagingSenderId: "319225747276",
    appId: "1:319225747276:web:5556b601dca17e760121e9"
  };
 // â˜… æ–°å¢ï¼šå¤šæ ¡æŸ¥çœ‹æ¨¡å¼ ç”¨ localStorage å­˜æ——æ¨™
  const ADMIN_MULTI_SCHOOL_KEY = "tkb_admin_multi_school_view";
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const adminUserInfo = document.getElementById("adminUserInfo");
  const logoutBtn = document.getElementById("logoutBtn");
 // â˜… æ–°å¢ï¼šå¤šæ ¡æŸ¥çœ‹ UI å…ƒç´ 
  const multiSchoolToggle = document.getElementById("multiSchoolToggle");
  const multiSchoolMsg = document.getElementById("multiSchoolMsg");
  // ä½¿ç”¨è€…ç®¡ç†å…ƒç´ 
  const userSearchInput = document.getElementById("userSearchInput");
  const userSearchBtn = document.getElementById("userSearchBtn");
  const userSearchMsg = document.getElementById("userSearchMsg");
  const userResultBox = document.getElementById("userResultBox");
  const userNicknameLabel = document.getElementById("userNicknameLabel");
  const userEmailLabel = document.getElementById("userEmailLabel");
  const userUidLabel = document.getElementById("userUidLabel");
  const userSchoolLabel = document.getElementById("userSchoolLabel");
  const userBanStatusTag = document.getElementById("userBanStatusTag");
  const banUserBtn = document.getElementById("banUserBtn");
  const unbanUserBtn = document.getElementById("unbanUserBtn");
  const resetTrustBtn = document.getElementById("resetTrustBtn");
  let currentTargetUserId = null;

  // ä»»å‹™ç®¡ç†å…ƒç´ 
  const taskSearchInput = document.getElementById("taskSearchInput");
  const taskSearchBtn = document.getElementById("taskSearchBtn");
  const taskSearchMsg = document.getElementById("taskSearchMsg");
  const taskResultBox = document.getElementById("taskResultBox");
  const taskTitleLabel = document.getElementById("taskTitleLabel");
  const taskMetaLabel = document.getElementById("taskMetaLabel");
  const taskStatusLabel = document.getElementById("taskStatusLabel");
  const removeTaskBtn = document.getElementById("removeTaskBtn");
  let currentTaskId = null;

  // è¨Šæ¯æª¢è¦–å…ƒç´ 
  const msgTaskIdInput = document.getElementById("msgTaskIdInput");
  const loadMessagesBtn = document.getElementById("loadMessagesBtn");
  const messagesMsg = document.getElementById("messagesMsg");
  const messagesList = document.getElementById("messagesList");
const schoolReqMsg = document.getElementById("schoolReqMsg");
const schoolReqList = document.getElementById("schoolReqList");
  // å­¸æ ¡è¨­å®šè¡¨å–®å…ƒç´ ï¼ˆæ‰‹å‹•å¡« â†’ /schoolsï¼‰
  const schoolConfigForm = document.getElementById("schoolConfigForm");
  const cfgSchoolId = document.getElementById("cfgSchoolId");
  const cfgSchoolName = document.getElementById("cfgSchoolName");
  const cfgLevelKey = document.getElementById("cfgLevelKey");
  const cfgLevelLabel = document.getElementById("cfgLevelLabel");
  const cfgCodePrefix = document.getElementById("cfgCodePrefix");
  const cfgGradeCount = document.getElementById("cfgGradeCount");
  const cfgClassCount = document.getElementById("cfgClassCount");
  const cfgMaxSeat = document.getElementById("cfgMaxSeat");
  const cfgEnabled = document.getElementById("cfgEnabled");
  const schoolConfigMsg = document.getElementById("schoolConfigMsg");
  // === å®˜æ–¹å…¬å‘Šç®¡ç†å…ƒç´  ===
  const annForm       = document.getElementById("annForm");
  const annTitleInput = document.getElementById("annTitle");
  const annContentInput = document.getElementById("annContent");
  const annImportantInput = document.getElementById("annImportant");
  const annMsg        = document.getElementById("annMsg");
  const annList       = document.getElementById("annList");
  // å»ºç«‹ / æ›´æ–°å­¸æ ¡è¨­å®šï¼šæ‰‹å‹•å¡« â†’ å¯«å…¥ /schools
  if (schoolConfigForm) {
    schoolConfigForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      schoolConfigMsg.style.color = "#9ca3af"; // slate-400
      schoolConfigMsg.textContent = "";

      const schoolId = (cfgSchoolId.value || "").trim();
      const schoolName = (cfgSchoolName.value || "").trim();
      const levelKey = (cfgLevelKey.value || "").trim() || "junior";
      const levelLabel = (cfgLevelLabel.value || "").trim() || "åœ‹ä¸­éƒ¨";
      const codePrefix = (cfgCodePrefix.value || "").trim() || "J";

      const gradeCount = parseInt(cfgGradeCount.value, 10);
      const classCount = parseInt(cfgClassCount.value, 10);
      const maxSeat = parseInt(cfgMaxSeat.value, 10);

      if (!schoolId) {
        schoolConfigMsg.textContent = "è«‹å…ˆè¼¸å…¥å­¸æ ¡æ–‡ä»¶ IDï¼ˆschoolIdï¼‰ã€‚";
        return;
      }

      if (!Number.isInteger(gradeCount) || gradeCount <= 0) {
        schoolConfigMsg.textContent = "è«‹å¡«å¯«æ­£ç¢ºçš„å¹´ç´šæ•¸ã€‚";
        return;
      }
      if (!Number.isInteger(classCount) || classCount <= 0) {
        schoolConfigMsg.textContent = "è«‹å¡«å¯«æ­£ç¢ºçš„æ¯å¹´ç´šç­ç´šæ•¸ã€‚";
        return;
      }
      if (!Number.isInteger(maxSeat) || maxSeat <= 0) {
        schoolConfigMsg.textContent = "è«‹å¡«å¯«æ­£ç¢ºçš„æ¯ç­æœ€å¤§äººæ•¸ã€‚";
        return;
      }

      // ä¾å¹´ç´šæ•¸çµ„å‡º [1,2,3,...] çš„ grades
      const grades = [];
      for (let i = 1; i <= gradeCount; i++) {
        grades.push(i);
      }

      const enabled = !!(cfgEnabled && cfgEnabled.checked);

      const payload = {
        name: schoolName || schoolId,
        enabled,
        levels: {
          [levelKey]: {
            label: levelLabel,
            codePrefix,
            grades,
            maxClassNo: classCount,
            maxSeatNo: maxSeat
          }
        },
        updatedAt: new Date()
      };

      try {
        // ç”¨ setDoc + merge: trueï¼Œå¯ä»¥è¦†è“‹æˆ–æ–°å¢é€™ä¸€é–“å­¸æ ¡
        const ref = doc(db, "schools", schoolId);
        await setDoc(ref, payload, { merge: true });

        schoolConfigMsg.style.color = "#4ade80"; // ç¶ è‰²
        schoolConfigMsg.textContent = "å·²æˆåŠŸå¯«å…¥ /schoolsï¼è¨»å†Šé å¯ä»¥ä½¿ç”¨é€™é–“å­¸æ ¡è¨­å®šã€‚";
      } catch (err) {
        console.error(err);
        schoolConfigMsg.style.color = "#f87171"; // ç´…è‰²
        schoolConfigMsg.textContent = "å¯«å…¥ /schools å¤±æ•—ï¼š" + err.message;
      }
    });
      // å»ºç«‹æ–°å…¬å‘Š
  if (annForm) {
    annForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      annMsg.style.color = "#9ca3af"; // slate-400
      annMsg.textContent = "";

      const title = (annTitleInput.value || "").trim();
      const content = (annContentInput.value || "").trim();
      const important = !!(annImportantInput && annImportantInput.checked);

      if (!title) {
        annMsg.textContent = "è«‹è¼¸å…¥å…¬å‘Šæ¨™é¡Œã€‚";
        return;
      }
      if (!content) {
        annMsg.textContent = "è«‹è¼¸å…¥å…¬å‘Šå…§å®¹ã€‚";
        return;
      }

      try {
        await addDoc(collection(db, "announcements"), {
          title,
          content,
          important,
          createdAt: new Date()
        });

        annForm.reset();
        annMsg.style.color = "#4ade80"; // ç¶ è‰²
        annMsg.textContent = "å…¬å‘Šå·²ç™¼å¸ƒã€‚";
        setTimeout(() => {
          annMsg.textContent = "";
          annMsg.style.color = "#9ca3af";
        }, 2000);
      } catch (err) {
        console.error(err);
        annMsg.style.color = "#f87171"; // ç´…è‰²
        annMsg.textContent = "ç™¼å¸ƒå…¬å‘Šå¤±æ•—ï¼š" + err.message;
      }
    });
  }

  }

// â˜… æ–°å¢é€™è¡Œï¼ˆä¸€å®šè¦åœ¨ subscribeSchoolRequests() ä¹‹å‰ï¼‰
const schoolReqDocs = new Map();
  function escapeHtml(str = "") {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatTs(ts) {
    if (!ts || !ts.toDate) return "";
    const d = ts.toDate();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }
    // ç›£è½å…¬å‘Šåˆ—è¡¨ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
  function subscribeAnnouncementsAdmin() {
    if (!annList) return;

    const annRef = collection(db, "announcements");
    const q = query(annRef, orderBy("createdAt", "desc"));

    onSnapshot(q, (snapshot) => {
      annList.innerHTML = "";

      if (snapshot.empty) {
        const li = document.createElement("li");
        li.className = "text-[11px] text-slate-400";
        li.textContent = "ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Šã€‚";
        annList.appendChild(li);
        return;
      }

      snapshot.forEach((docSnap) => {
        const data = docSnap.data() || {};
        const li = document.createElement("li");
        li.className =
          "rounded-xl border border-slate-700 bg-slate-900/90 px-3 py-2 flex flex-col gap-1";

        const titleRow = document.createElement("div");
        titleRow.className = "flex items-center justify-between gap-2";

        const titleSpan = document.createElement("div");
        titleSpan.className = "font-semibold text-slate-50 text-xs sm:text-sm";
        titleSpan.textContent = data.title || "(æœªå‘½åå…¬å‘Š)";

        const rightBox = document.createElement("div");
        rightBox.className = "flex items-center gap-2 text-[11px]";

        if (data.important) {
          const tag = document.createElement("span");
          tag.className =
            "inline-flex items-center rounded-full border border-amber-400/60 bg-amber-500/20 px-2 py-0.5 text-amber-100";
          tag.textContent = "é‡è¦";
          rightBox.appendChild(tag);
        }

        const timeSpan = document.createElement("span");
        timeSpan.className = "text-slate-400";
        timeSpan.textContent = formatTs(data.createdAt);
        rightBox.appendChild(timeSpan);

        const delBtn = document.createElement("button");
        delBtn.className =
          "px-2 py-0.5 rounded-full border border-rose-400/60 bg-rose-500/20 text-rose-100 hover:bg-rose-500/30";
        delBtn.textContent = "åˆªé™¤";
        delBtn.addEventListener("click", async () => {
          if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿåˆªé™¤å¾Œæ‰€æœ‰ä½¿ç”¨è€…éƒ½çœ‹ä¸åˆ°ã€‚")) return;
          try {
            await deleteDoc(doc(db, "announcements", docSnap.id));
          } catch (err) {
            console.error(err);
            alert("åˆªé™¤å…¬å‘Šå¤±æ•—ï¼š" + err.message);
          }
        });

        rightBox.appendChild(delBtn);

        titleRow.appendChild(titleSpan);
        titleRow.appendChild(rightBox);

        const contentP = document.createElement("p");
        contentP.className = "text-[11px] sm:text-xs text-slate-200 whitespace-pre-wrap";
        contentP.textContent = data.content || "";

        li.appendChild(titleRow);
        li.appendChild(contentP);
        annList.appendChild(li);
      });
    });
  }

  // ç™»å‡º
  logoutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "login.html";
    } catch (err) {
      console.error(err);
      alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡");
    }
  });

  // ç›£è½ç™»å…¥ç‹€æ…‹ & ç®¡ç†è€…æª¢æŸ¥
   onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    if (user.uid !== ADMIN_UID) {
      alert("ä½ æ²’æœ‰æ¬Šé™æŸ¥çœ‹ç®¡ç†å¾Œå°ã€‚");
      window.location.href = "tasks.html";
      return;
    }

        adminUserInfo.textContent = user.email || user.uid;
    // âœ… åªæœ‰ç®¡ç†å“¡ç™»å…¥å¾Œæ‰é–‹å§‹ç›£è½
    subscribeSchoolRequests();
    subscribeAnnouncementsAdmin();   // â­ æ–°å¢ï¼šç›£è½å…¬å‘Š


    // â˜… åªæœ‰ç®¡ç†å“¡ç™»å…¥å¾Œæ‰è™•ç†å¤šæ ¡æŸ¥çœ‹ UI
    if (multiSchoolToggle && multiSchoolMsg) {
      const flag = localStorage.getItem(ADMIN_MULTI_SCHOOL_KEY) === "1";
      multiSchoolToggle.checked = flag;
      multiSchoolMsg.textContent = flag
        ? "ç›®å‰ç‚ºï¼šå¤šæ ¡æŸ¥çœ‹æ¨¡å¼ï¼ˆä»»å‹™å»£å ´ / æˆ‘çš„ä»»å‹™æœƒé¡¯ç¤ºæ‰€æœ‰å­¸æ ¡ï¼‰"
        : "ç›®å‰ç‚ºï¼šå–®æ ¡æ¨¡å¼ï¼ˆåªé¡¯ç¤ºè‡ªå·±å­¸æ ¡çš„ä»»å‹™ï¼‰";

      multiSchoolToggle.addEventListener("change", () => {
        const enabled = multiSchoolToggle.checked;
        localStorage.setItem(ADMIN_MULTI_SCHOOL_KEY, enabled ? "1" : "0");
        multiSchoolMsg.textContent = enabled
          ? "å·²åˆ‡æ›ç‚ºå¤šæ ¡æŸ¥çœ‹æ¨¡å¼ï¼Œä¸‹æ¬¡åœ¨ä»»å‹™å»£å ´ / æˆ‘çš„ä»»å‹™é‡æ–°è¼‰å…¥å¾Œç”Ÿæ•ˆã€‚"
          : "å·²åˆ‡æ›ç‚ºå–®æ ¡æ¨¡å¼ï¼Œä¸‹æ¬¡åœ¨ä»»å‹™å»£å ´ / æˆ‘çš„ä»»å‹™é‡æ–°è¼‰å…¥å¾Œç”Ÿæ•ˆã€‚";
      });
    }

    // âœ… åªæœ‰ç®¡ç†å“¡ç™»å…¥å¾Œæ‰é–‹å§‹ç›£è½å­¸æ ¡ç”³è«‹
    subscribeSchoolRequests();
  });
  // ============= ä½¿ç”¨è€…æœå°‹ & å°é– =============
  userSearchBtn.addEventListener("click", async () => {
    const keyword = userSearchInput.value.trim();
    userSearchMsg.textContent = "";
    userResultBox.classList.add("hidden");
    currentTargetUserId = null;

    if (!keyword) {
      userSearchMsg.textContent = "è«‹è¼¸å…¥ Email æˆ– UIDã€‚";
      return;
    }

    try {
      let targetDoc = null;

      // å¦‚æœçœ‹èµ·ä¾†åƒ UIDï¼ˆ28~36 ä½éš¨æ©Ÿå­—ä¸²ï¼‰ï¼Œå…ˆè©¦è®€ /users/{uid}
      if (keyword.length >= 20) {
        const docRef = doc(db, "users", keyword);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          targetDoc = snap;
        }
      }

      // å¦‚æœé‚„æ²’æ‰¾åˆ°ï¼Œç•¶æˆ email ä¾†æŸ¥
      if (!targetDoc) {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", keyword));
        const snap = await getDocs(q);
        if (!snap.empty) {
          targetDoc = snap.docs[0];
        }
      }

      if (!targetDoc) {
        userSearchMsg.textContent = "æ‰¾ä¸åˆ°é€™å€‹ä½¿ç”¨è€…ã€‚";
        return;
      }

      const data = targetDoc.data();
      currentTargetUserId = targetDoc.id;

      userNicknameLabel.textContent = data.nickname || "(æœªè¨­å®šæš±ç¨±)";
      userEmailLabel.textContent = `Emailï¼š${data.email || "æœªçŸ¥"}`;
      userUidLabel.textContent = `UIDï¼š${targetDoc.id}`;
      userSchoolLabel.textContent =
        (data.schoolName || data.schoolId || "æœªçŸ¥å­¸æ ¡") +
        (data.grade ? ` Â· ${data.grade} å¹´ ${data.classNo || ""} ç­` : "");

      const isBanned = !!data.isBanned;
      if (isBanned) {
        userBanStatusTag.textContent = "ç›®å‰ç‹€æ…‹ï¼šå·²å°é–";
        userBanStatusTag.className =
          "inline-flex items-center rounded-full border border-rose-400/70 px-2 py-0.5 text-[11px] bg-rose-500/20 text-rose-100";
      } else {
        userBanStatusTag.textContent = "ç›®å‰ç‹€æ…‹ï¼šæ­£å¸¸";
        userBanStatusTag.className =
          "inline-flex items-center rounded-full border border-emerald-400/70 px-2 py-0.5 text-[11px] bg-emerald-500/15 text-emerald-100";
      }

      userResultBox.classList.remove("hidden");
      userSearchMsg.textContent = "";
    } catch (err) {
      console.error(err);
      userSearchMsg.textContent = "æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚";
    }
  });

  banUserBtn.addEventListener("click", async () => {
  if (!currentTargetUserId) {
    alert("è«‹å…ˆæœå°‹ä¸¦é¸æ“‡è¦å°é–çš„ä½¿ç”¨è€…ã€‚");
    return;
  }

  const reason = window.prompt(
    "è«‹è¼¸å…¥å°é–åŸå› ï¼ˆé€™æ®µæ–‡å­—æœƒé¡¯ç¤ºçµ¦è©²ä½¿ç”¨è€…ï¼‰ï¼š",
    "é•åã€Œé™¶å‰é¨å£«åœ˜ä»»å‹™æ¿ã€ä½¿ç”¨è¦ç¯„"
  );

  // æŒ‰ã€Œå–æ¶ˆã€å°±ä¸å°é–
  if (reason === null) return;

  if (!confirm("ç¢ºå®šè¦å°é–é€™ä½ä½¿ç”¨è€…å—ï¼Ÿ")) {
    return;
  }

  try {
    const userRef = doc(db, "users", currentTargetUserId);
    await updateDoc(userRef, {
      isBanned: true,
      bannedAt: new Date(),
      banReason: (reason || "é•åã€Œé™¶å‰é¨å£«åœ˜ä»»å‹™æ¿ã€ä½¿ç”¨è¦ç¯„").trim()
    });

    alert("å·²å°é–è©²ä½¿ç”¨è€…ã€‚");
    userBanStatusTag.textContent = "å·²å°é–";
    userBanStatusTag.className =
      "inline-flex items-center gap-1 rounded-full bg-rose-500/15 px-2 py-0.5 text-[11px] text-rose-300 border border-rose-400/40";
  } catch (err) {
    console.error(err);
    alert("å°é–å¤±æ•—ï¼š" + err.message);
  }
});


  unbanUserBtn.addEventListener("click", async () => {
    if (!currentTargetUserId) return;
    if (!confirm("è¦è§£é™¤å°é–é€™å€‹å¸³è™Ÿå—ï¼Ÿ")) return;

    try {
      await updateDoc(doc(db, "users", currentTargetUserId), {
        isBanned: false
      });
      userSearchBtn.click();
      alert("å·²è§£é™¤å°é–ã€‚");
    } catch (err) {
      console.error(err);
      alert("è§£é™¤å°é–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
    await updateDoc(userRef, {
  isBanned: false,
  bannedAt: null,
  banReason: ""
});
  });

  // é‡è¨­ Knightï¼šåˆªé™¤æ‰€æœ‰çµ¦ä»–çš„è©•åƒ¹ï¼ˆtoUserId = æ­¤ UIDï¼‰
  resetTrustBtn.addEventListener("click", async () => {
    if (!currentTargetUserId) return;
    if (!confirm("é€™æœƒåˆªé™¤æ‰€æœ‰ã€çµ¦é€™ä½ä½¿ç”¨è€…ã€çš„è©•åƒ¹ç´€éŒ„ï¼Œç¢ºå®šè¦é‡è¨­å—ï¼Ÿ")) return;

    try {
      const reviewsRef = collection(db, "task_reviews");
      const q = query(reviewsRef, where("toUserId", "==", currentTargetUserId));
      const snap = await getDocs(q);
      if (snap.empty) {
        alert("ç›®å‰æ²’æœ‰ä»»ä½•è©•åƒ¹ï¼Œä¸éœ€é‡è¨­ã€‚");
        return;
      }

      // é€ç­†åˆªé™¤ï¼ˆæ•¸é‡é€šå¸¸ä¸å¤šï¼‰
      const batchDeletes = [];
      for (const docSnap of snap.docs) {
        batchDeletes.push(docSnap.ref.delete());
      }
      await Promise.all(batchDeletes);

      alert(`å·²åˆªé™¤ ${snap.size} ç­†è©•åƒ¹ï¼ŒKnight ä¿¡ä»»åˆ†æ•¸å·²é‡è¨­ã€‚`);
    } catch (err) {
      console.error(err);
      alert("é‡è¨­å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  });

  // ============= ä»»å‹™æœå°‹ & ä¸‹æ¶ =============
  taskSearchBtn.addEventListener("click", async () => {
    const id = taskSearchInput.value.trim();
    taskSearchMsg.textContent = "";
    taskResultBox.classList.add("hidden");
    currentTaskId = null;

    if (!id) {
      taskSearchMsg.textContent = "è«‹è¼¸å…¥ä»»å‹™ IDã€‚";
      return;
    }

    try {
      const ref = doc(db, "tasks", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        taskSearchMsg.textContent = "æ‰¾ä¸åˆ°é€™å€‹ä»»å‹™ã€‚";
        return;
      }

      const data = snap.data();
      currentTaskId = id;

      taskTitleLabel.textContent = data.title || "(ç„¡æ¨™é¡Œ)";
      taskMetaLabel.textContent =
        `ç‹€æ…‹ï¼š${data.status || "æœªçŸ¥"} ï½œ ç™¼å–®è€…ï¼š${data.creatorId || "?"} ï½œ æ¥å–®è€…ï¼š${data.takerId || "å°šæœªæ¥å–®"}`;
      taskStatusLabel.textContent = data.status === "removedByAdmin"
        ? "ç›®å‰ç‚ºï¼šå·²ä¸‹æ¶ï¼ˆremovedByAdminï¼‰"
        : `ç›®å‰ç‚ºï¼š${data.status || "æœªçŸ¥"}`;

      taskResultBox.classList.remove("hidden");
    } catch (err) {
      console.error(err);
      taskSearchMsg.textContent = "æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    }
  });

  removeTaskBtn.addEventListener("click", async () => {
    if (!currentTaskId) return;
    if (!confirm("ç¢ºå®šè¦å°‡æ­¤ä»»å‹™æ¨™è¨˜ç‚ºã€å·²ä¸‹æ¶ã€å—ï¼Ÿ\nä¸€èˆ¬ä»»å‹™åˆ—è¡¨å°‡ä¸å†é¡¯ç¤ºã€‚")) return;

    try {
      const ref = doc(db, "tasks", currentTaskId);
      await updateDoc(ref, {
        status: "removedByAdmin",
        removedByAdmin: true,
        removedAt: new Date()
      });
      alert("å·²æ¨™è¨˜ç‚ºä¸‹æ¶ã€‚");
      taskSearchBtn.click();
    } catch (err) {
      console.error(err);
      alert("ä¸‹æ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  });

  // ============= è¨Šæ¯æª¢è¦– =============
  loadMessagesBtn.addEventListener("click", async () => {
    const taskId = msgTaskIdInput.value.trim();
    messagesMsg.textContent = "";
    messagesList.innerHTML = "";

    if (!taskId) {
      messagesMsg.textContent = "è«‹è¼¸å…¥ä»»å‹™ IDã€‚";
      return;
    }

    try {
      const msgsRef = collection(db, "messages");
const q = query(
  msgsRef,
  where("taskId", "==", taskId)
);
const snap = await getDocs(q);
// ğŸ‘‰ åœ¨å‰ç«¯è‡ªå·±ä¾ createdAt æ’åºï¼ˆèˆŠ â†’ æ–°ï¼‰
const docs = snap.docs.slice().sort((a, b) => {
  const da = a.data().createdAt;
  const db_ = b.data().createdAt;
  if (!da || !da.toDate) return -1;
  if (!db_ || !db_.toDate) return 1;
  return da.toDate() - db_.toDate();
});

      if (snap.empty) {
        messagesMsg.textContent = "æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨Šæ¯ã€‚";
        return;
      }

      messagesMsg.textContent = `å…± ${snap.size} å‰‡è¨Šæ¯ï¼š`;
      docs.forEach((docSnap) => {
  const m = docSnap.data();
  const div = document.createElement("div");
  div.className =
    "rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2";
  div.innerHTML = `
    <div class="flex items-center justify-between gap-2 mb-1">
      <div class="text-[11px] text-slate-300">
        fromUserIdï¼š${escapeHtml(m.fromUserId || "")}
      </div>
      <div class="text-[11px] text-slate-500">
        ${formatTs(m.createdAt)}
      </div>
    </div>
    <div class="text-xs sm:text-sm text-slate-100 whitespace-pre-wrap break-words">
      ${escapeHtml(m.text || m.message || "")}
    </div>
  `;
  messagesList.appendChild(div);
});
    } catch (err) {
      console.error(err);
      messagesMsg.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    }
  });
    // ============= å­¸æ ¡ç”³è«‹ç®¡ç†ï¼ˆschool_requests â†’ schoolsï¼‰ =============

  // é¡¯ç¤º level çš„æ–‡å­—
  function getLevelLabel(level) {
    if (level === "junior") return "åœ‹ä¸­";
    if (level === "senior") return "é«˜ä¸­ / é«˜è·";
    if (level === "elementary") return "åœ‹å°";
    if (level === "college") return "å¤§å­¸ / å°ˆç§‘";
    if (level === "other") return "å…¶ä»– / æœªåˆ†é¡";
    return level || "æœªæŒ‡å®š";
  }

  function subscribeSchoolRequests() {
    if (!schoolReqList || !schoolReqMsg) return;

    schoolReqMsg.textContent = "è¼‰å…¥ä¸­â€¦";

    const reqRef = collection(db, "school_requests");
    const q = query(reqRef, orderBy("createdAt", "desc"));

    onSnapshot(
      q,
      (snapshot) => {
        schoolReqDocs.clear();
        schoolReqList.innerHTML = "";

        if (snapshot.empty) {
          schoolReqMsg.textContent = "ç›®å‰æ²’æœ‰ä»»ä½•å­¸æ ¡æ–°å¢ç”³è«‹ã€‚";
          return;
        }

        schoolReqMsg.textContent = `å…± ${snapshot.size} ç­†ç”³è«‹ï¼š`;

        snapshot.forEach((docSnap) => {
          const data = docSnap.data() || {};
          const id = docSnap.id;
          schoolReqDocs.set(id, data);

          const li = document.createElement("li");

          const status = data.status || "pending";
          let statusLabel = "";
          let statusClass =
            "inline-flex items-center rounded-full border px-2 py-0.5 text-[11px]";

          if (status === "pending") {
            statusLabel = "å¾…è™•ç†";
            statusClass +=
              " border-amber-400/70 bg-amber-500/15 text-amber-100";
          } else if (status === "approved") {
            statusLabel = "å·²åŠ å…¥ schools";
            statusClass +=
              " border-emerald-400/70 bg-emerald-500/15 text-emerald-100";
          } else if (status === "rejected") {
            statusLabel = "å·²æ¨™è¨˜ç‚ºè™•ç†å®Œç•¢";
            statusClass +=
              " border-slate-500/70 bg-slate-800 text-slate-200";
          } else {
            statusLabel = status;
            statusClass +=
              " border-slate-500/70 bg-slate-800 text-slate-200";
          }

          const createdAtStr = data.createdAt && data.createdAt.toDate
            ? formatTs(data.createdAt)
            : "";

          li.className =
            "rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 space-y-1";

          li.innerHTML = `
  <div class="flex flex-wrap items-center justify-between gap-2">
    <div>
      <div class="font-semibold text-slate-50">
        ${escapeHtml(data.schoolName || "(æœªå¡«å­¸æ ¡åç¨±)")}
      </div>
      <div class="text-[11px] text-slate-400">
        å±¤ç´šï¼š${escapeHtml(getLevelLabel(data.level))}
        ${
          createdAtStr
            ? `ï½œ é€å‡ºæ™‚é–“ï¼š${escapeHtml(createdAtStr)}`
            : ""
        }
      </div>
      <div class="text-[11px] text-slate-400">
        å¹´ç´šæ•¸ï¼š${data.gradeCount ?? "æœªå¡«"}
        ï½œ æ¯å¹´ç´šç­ç´šæ•¸ï¼š${data.classCount ?? "æœªå¡«"}
        ï½œ æ¯ç­æœ€å¤§äººæ•¸ï¼š${data.maxSeatPerClass ?? "æœªå¡«"}
      </div>
      <div class="text-[11px] text-slate-500">
        ç”³è«‹äºº UIDï¼š${escapeHtml(data.uid || "(æœªç™»å…¥ / æœªç´€éŒ„)")}
      </div>
    </div>
    <span class="${statusClass}">${statusLabel}</span>
  </div>

  ${
    data.comment
      ? `<div class="text-xs text-slate-200 whitespace-pre-wrap break-words mt-1">
           ${escapeHtml(data.comment)}
         </div>`
      : ""
  }

  <div class="flex flex-wrap justify-end gap-2 mt-2">
    ${
      status === "pending"
        ? `
      <button
        data-id="${id}"
        data-action="approve"
        class="px-2.5 py-1 rounded-full text-[11px] bg-emerald-500/20 text-emerald-100 border border-emerald-400/70 hover:bg-emerald-500/30">
        âœ… æ¨™è¨˜ç‚ºå·²å¯©æ ¸é€šé
      </button>
      <button
        data-id="${id}"
        data-action="reject"
        class="px-2.5 py-1 rounded-full text-[11px] bg-slate-700/60 text-slate-100 border border-slate-500/70 hover:bg-slate-700">
        æ¨™è¨˜ç‚ºå·²è™•ç†ï¼ˆç•¥éï¼‰
      </button>
    `
        : ""
    }
  </div>
`;


          schoolReqList.appendChild(li);
        });
      },
      (err) => {
        console.error("è¼‰å…¥ school_requests å¤±æ•—", err);
        schoolReqMsg.textContent = "è¼‰å…¥ school_requests å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    );
  }

  // é»æŒ‰éˆ•ï¼šåŠ å…¥ schools / æ¨™è¨˜å·²è™•ç†
  if (schoolReqList) {
  schoolReqList.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const id = btn.dataset.id;
    const action = btn.dataset.action;
    const data = schoolReqDocs.get(id) || {};

    if (!id) return;

    try {
      if (action === "approve") {
        if (
          !confirm(
            `ç¢ºå®šè¦å°‡ã€Œ${data.schoolName || "(æœªå¡«å­¸æ ¡åç¨±)"}ã€æ¨™è¨˜ç‚ºå·²å¯©æ ¸é€šéå—ï¼Ÿ`
          )
        ) {
          return;
        }

        await updateDoc(doc(db, "school_requests", id), {
          status: "approved",
          processedAt: new Date()
        });

        alert("å·²æ¨™è¨˜ç‚ºã€å·²å¯©æ ¸é€šéã€ã€‚è«‹åˆ° Firestore çš„ schools é›†åˆæ‰‹å‹•å»ºç«‹å­¸æ ¡è¨­å®šã€‚");
      } else if (action === "reject") {
        if (!confirm("ç¢ºå®šè¦å°‡æ­¤ç”³è«‹æ¨™è¨˜ç‚ºã€å·²è™•ç†ï¼ˆç•¥éï¼‰ã€å—ï¼Ÿ"))
          return;

        await updateDoc(doc(db, "school_requests", id), {
          status: "rejected",
          processedAt: new Date()
        });

        alert("å·²å°‡ç”³è«‹æ¨™è¨˜ç‚ºã€å·²è™•ç†ï¼ˆç•¥éï¼‰ã€ã€‚");
      }
    } catch (err) {
      console.error(err);
      alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  });
}


</script>
<style>
  input, textarea, select {
    color: #1f2937 !important;  /* slate-800 æ·±ç° */
  }
</style>
<p class="text-[11px] text-slate-500 mt-6 text-center">
  æœ¬å¹³å°åƒ…ä¾›æ ¡å…§ä»»å‹™åª’åˆä½¿ç”¨ï¼Œæ‰€æœ‰è³‡æ–™åƒ…ä½œç‚ºä»»å‹™ç®¡ç†åŠè¯ç¹«ç”¨é€”ï¼Œä¸æœƒå°å¤–å…¬é–‹æˆ–æä¾›çµ¦ç¬¬ä¸‰æ–¹ã€‚
</p>
</body>
</html>
